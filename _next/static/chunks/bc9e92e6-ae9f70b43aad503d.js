"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[992],{4150:(e,t,n)=>{n.d(t,{GG:()=>l5,aU:()=>le,rJ:()=>o3});var r,i,s,a,o=n(1972),l=n(7086),u=n(4075),h=n(6959),c=n(7898),d=n(426),f=n(2818),m=n(5714).Buffer;let g="@firebase/firestore",p="4.7.9";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.4.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let n=t.map(b);v.debug(`Firestore (${w}): ${e}`,...n)}}function E(e,...t){if(v.logLevel<=u.$b.ERROR){let n=t.map(b);v.error(`Firestore (${w}): ${e}`,...n)}}function _(e,...t){if(v.logLevel<=u.$b.WARN){let n=t.map(b);v.warn(`Firestore (${w}): ${e}`,...n)}}function b(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e="Unexpected state"){let t=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: `+e;throw E(t),Error(t)}let S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class D{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class C{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class k{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||x();let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new D;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new D,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new D)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||x(),new C(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||x(),new y(e)}}class R{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);let e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class M{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new R(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class O{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){void 0===this.o||x();let n=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.R;return this.R=e.token,T("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?r(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.V)return Promise.resolve(new O(this.V));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||x(),this.R=e.token,new O(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class F{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function P(e,t){return e<t?-1:+(e>t)}function U(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class q{static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new q(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new N(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new N(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?P(this.nanoseconds,e.nanoseconds):P(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{static fromTimestamp(e){return new B(e)}static min(){return new B(new q(0,0))}static max(){return new B(new q(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let K="__name__";class z{constructor(e,t,n){void 0===t?t=0:t>e.length&&x(),void 0===n?n=e.length-t:n>e.length-t&&x(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===z.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof z?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=z.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return Math.sign(e.length-t.length)}static compareSegments(e,t){let n=z.isNumericId(e),r=z.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?z.extractNumericId(e).compare(z.extractNumericId(t)):e<t?-1:+(e>t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class $ extends z{construct(e,t,n){return new $(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new N(S.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new $(t)}static emptyPath(){return new $([])}}let G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class j extends z{construct(e,t,n){return new j(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),j.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===K}static keyField(){return new j([K])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new N(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new N(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new N(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new j(t)}static emptyPath(){return new j([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q($.fromString(e))}static fromName(e){return new Q($.fromString(e).popFirst(5))}static empty(){return new Q($.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===$.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return $.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new $(e.slice()))}}class H{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function W(e){return e.fields.find(e=>2===e.kind)}function Y(e){return e.fields.filter(e=>2!==e.kind)}H.UNKNOWN_ID=-1;class Z{constructor(e,t){this.fieldPath=e,this.kind=t}}class J{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new J(0,et.min())}}function X(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new et(B.fromTimestamp(1e9===r?new q(n+1,0):new q(n,r)),Q.empty(),t)}function ee(e){return new et(e.readTime,e.key,-1)}class et{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new et(B.min(),Q.empty(),-1)}static max(){return new et(B.max(),Q.empty(),-1)}}function en(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=Q.comparator(e.documentKey,t.documentKey))?n:P(e.largestBatchId,t.largestBatchId)}let er="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ei{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function es(e){if(e.code!==S.FAILED_PRECONDITION||e.message!==er)throw e;T("LocalStore","Unexpectedly lost primary lease")}class ea{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ea((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ea?t:ea.resolve(t)}catch(e){return ea.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.reject(t)}static resolve(e){return new ea((t,n)=>{t(e)})}static reject(e){return new ea((t,n)=>{n(e)})}static waitFor(e){return new ea((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ea.resolve(!1);for(let n of e)t=t.next(e=>e?ea.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ea((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ea((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let eo="SimpleDb";class el{static open(e,t,n,r){try{return new el(t,e.transaction(r,n))}catch(e){throw new ed(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new D,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new ed(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{let n=ey(t.target.error);this.m.reject(new ed(e,n))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(T(eo,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new em(this.transaction.objectStore(e))}}class eu{static delete(e){return T(eo,"Removing database:",e),eg(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(eu.v())return!0;let e=(0,h.ZQ)(),t=eu.C(e),n=eh(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static v(){var e;return void 0!==f&&"YES"===(null===(e=f.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.O=n,12.2===eu.C((0,h.ZQ)())&&E("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(T(eo,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new ed(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new N(S.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new N(S.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ed(e,r))},r.onupgradeneeded=e=>{T(eo,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.O.B(t,r.transaction,e.oldVersion,this.version).next(()=>{T(eo,"Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.N(e);let t=el.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.S(),e)).catch(e=>(t.abort(e),ea.reject(e))).toPromise();return s.catch(()=>{}),await t.p,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(eo,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eh(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ec{constructor(e){this.q=e,this.$=!1,this.K=null}get isDone(){return this.$}get U(){return this.K}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.K=e}delete(){return eg(this.q.delete())}}class ed extends N{constructor(e,t){super(S.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ef(e){return"IndexedDbTransactionError"===e.name}class em{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(T(eo,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(T(eo,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eg(n)}add(e){return T(eo,"ADD",this.store.name,e,e),eg(this.store.add(e))}get(e){return eg(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(eo,"GET",this.store.name,e,t),t))}delete(e){return T(eo,"DELETE",this.store.name,e),eg(this.store.delete(e))}count(){return T(eo,"COUNT",this.store.name),eg(this.store.count())}G(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ea((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.j(e,(e,n)=>{t.push(n)}).next(()=>t)}}H(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ea((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}J(e,t){T(eo,"DELETE ALL",this.store.name);let n=this.options(e,t);n.Y=!1;let r=this.cursor(n);return this.j(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.j(r,t)}X(e){let t=this.cursor({});return new ea((n,r)=>{t.onerror=e=>{r(ey(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}j(e,t){let n=[];return new ea((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new ec(i),a=t(i.primaryKey,i.value,s);if(a instanceof ea){let e=a.catch(e=>(s.done(),ea.reject(e)));n.push(e)}s.isDone?r():null===s.U?i.continue():i.continue(s.U)}}).next(()=>ea.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eg(e){return new ea((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(ey(e.target.error))}})}let ep=!1;function ey(e){let t=eu.C((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ep||(ep=!0,setTimeout(()=>{throw e},0)),e}}return e}let ew="IndexBackfiller";class ev{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){T(ew,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ee.ne();T(ew,`Documents written: ${e}`)}catch(e){ef(e)?T(ew,"Ignoring IndexedDB error during index backfill: ",e):await es(e)}await this.te(6e4)})}}class eI{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.re(t,e))}re(e,t){let n=new Set,r=t,i=!0;return ea.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return T(ew,`Processing collection: ${t}`),this.ie(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}ie(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.se(r,n)).next(n=>(T(ew,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=ee(t);en(r,n)>0&&(n=r)}),new et(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eT{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this._e&&this._e(e),e}}function eE(e){return null==e}function e_(e){return 0===e&&1/e==-1/0}function eb(e){return"number"==typeof e&&Number.isInteger(e)&&!e_(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function ex(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}eT.ae=-1;function eS(e){let t=e.length;if(t>=2||x(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||x(),$.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&x(),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x()}s=t+2}return new $(r)}let eN="remoteDocuments",eD="owner",eC="owner",ek="mutationQueues",eA="mutations",eV="batchId",eR="userMutationsIndex",eM=["userId","batchId"],eO={},eL="documentMutations",eF="remoteDocumentsV14",eP=["prefixPath","collectionGroup","readTime","documentId"],eU="documentKeyIndex",eq=["prefixPath","collectionGroup","documentId"],eB="collectionGroupIndex",eK=["collectionGroup","readTime","prefixPath","documentId"],ez="remoteDocumentGlobal",e$="remoteDocumentGlobalKey",eG="targets",ej="queryTargetsIndex",eQ=["canonicalId","targetId"],eH="targetDocuments",eW=["targetId","path"],eY="documentTargetsIndex",eZ=["path","targetId"],eJ="targetGlobalKey",eX="targetGlobal",e0="collectionParents",e1=["collectionId","parent"],e2="clientMetadata",e5="bundles",e8="namedQueries",e4="indexConfiguration",e3="collectionGroupIndex",e6="indexState",e9=["indexId","uid"],e7="sequenceNumberIndex",te=["uid","sequenceNumber"],tt="indexEntries",tn=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tr="documentKeyIndex",ti=["indexId","uid","orderedDocumentKey"],ts="documentOverlays",ta=["userId","collectionPath","documentId"],to="collectionPathOverlayIndex",tl=["userId","collectionPath","largestBatchId"],tu="collectionGroupOverlayIndex",th=["userId","collectionGroup","largestBatchId"],tc="globals",td=[ek,eA,eL,eN,eG,eD,eX,eH,e2,ez,e0,e5,e8],tf=[...td,ts],tm=[ek,eA,eL,eF,eG,eD,eX,eH,e2,ez,e0,e5,e8,ts],tg=[...tm,e4,e6,tt],tp=[...tg,tc];class ty extends ei{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function tw(e,t){return eu.M(e.ue,t)}function tv(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tI(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tT(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tE{constructor(e,t){this.comparator=e,this.root=t||tb.EMPTY}insert(e,t){return new tE(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tb.BLACK,null,null))}remove(e){return new tE(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tb.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new t_(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new t_(this.root,e,this.comparator,!1)}getReverseIterator(){return new t_(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new t_(this.root,e,this.comparator,!0)}}class t_{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tb{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tb.RED,this.left=null!=r?r:tb.EMPTY,this.right=null!=i?i:tb.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tb(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tb.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tb.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tb.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tb.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw x();let e=this.left.check();if(e!==this.right.check())throw x();return e+ +!this.isRed()}}tb.EMPTY=null,tb.RED=!0,tb.BLACK=!1,tb.EMPTY=new class{constructor(){this.size=0}get key(){throw x()}get value(){throw x()}get color(){throw x()}get left(){throw x()}get right(){throw x()}copy(e,t,n,r,i){return this}insert(e,t,n){return new tb(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tx{constructor(e){this.comparator=e,this.data=new tE(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tS(this.data.getIterator())}getIteratorFrom(e){return new tS(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tx)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tx(this.comparator);return t.data=e,t}}class tS{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tN(e){return e.hasNext()?e.getNext():void 0}class tD{constructor(e){this.fields=e,e.sort(j.comparator)}static empty(){return new tD([])}unionWith(e){let t=new tx(j.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tD(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return U(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tC extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tk{constructor(e){this.binaryString=e}static fromBase64String(e){return new tk(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tC("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tk(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return P(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tk.EMPTY_BYTE_STRING=new tk("");let tA=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tV(e){if(e||x(),"string"==typeof e){let t=0,n=tA.exec(e);if(n||x(),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tR(e.seconds),nanos:tR(e.nanos)}}function tR(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tM(e){return"string"==typeof e?tk.fromBase64String(e):tk.fromUint8Array(e)}let tO="server_timestamp",tL="__type__",tF="__previous_value__",tP="__local_write_time__";function tU(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tL])||void 0===n?void 0:n.stringValue)===tO}function tq(e){let t=e.mapValue.fields[tF];return tU(t)?tq(t):t}function tB(e){let t=tV(e.mapValue.fields[tP].timestampValue);return new q(t.seconds,t.nanos)}class tK{constructor(e,t,n,r,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}let tz="(default)";class t${constructor(e,t){this.projectId=e,this.database=t||tz}static empty(){return new t$("","")}get isDefaultDatabase(){return this.database===tz}isEqual(e){return e instanceof t$&&e.projectId===this.projectId&&e.database===this.database}}let tG="__type__",tj="__max__",tQ={mapValue:{fields:{__type__:{stringValue:tj}}}},tH="__vector__",tW="value",tY={nullValue:"NULL_VALUE"};function tZ(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tU(e)?4:nn(e)?0x1fffffffffffff:ne(e)?10:11:x()}function tJ(e,t){if(e===t)return!0;let n=tZ(e);if(n!==tZ(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tB(e).isEqual(tB(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let n=tV(e.timestampValue),r=tV(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return tM(e.bytesValue).isEqual(tM(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tR(e.geoPointValue.latitude)===tR(t.geoPointValue.latitude)&&tR(e.geoPointValue.longitude)===tR(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tR(e.integerValue)===tR(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tR(e.doubleValue),r=tR(t.doubleValue);return n===r?e_(n)===e_(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return U(e.arrayValue.values||[],t.arrayValue.values||[],tJ);case 10:case 11:return function(e,t){let n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tv(n)!==tv(r))return!1;for(let e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!tJ(n[e],r[e])))return!1;return!0}(e,t);default:return x()}}function tX(e,t){return void 0!==(e.values||[]).find(e=>tJ(e,t))}function t0(e,t){if(e===t)return 0;let n=tZ(e),r=tZ(t);if(n!==r)return P(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return P(e.booleanValue,t.booleanValue);case 2:return function(e,t){let n=tR(e.integerValue||e.doubleValue),r=tR(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return t1(e.timestampValue,t.timestampValue);case 4:return t1(tB(e),tB(t));case 5:return P(e.stringValue,t.stringValue);case 6:return function(e,t){let n=tM(e),r=tM(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=P(n[e],r[e]);if(0!==t)return t}return P(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=P(tR(e.latitude),tR(t.latitude));return 0!==n?n:P(tR(e.longitude),tR(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return t2(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null===(n=a[tW])||void 0===n?void 0:n.arrayValue,u=null===(r=o[tW])||void 0===r?void 0:r.arrayValue,h=P((null===(i=null==l?void 0:l.values)||void 0===i?void 0:i.length)||0,(null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0);return 0!==h?h:t2(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===tQ.mapValue&&t===tQ.mapValue)return 0;if(e===tQ.mapValue)return 1;if(t===tQ.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=P(r[e],s[e]);if(0!==t)return t;let a=t0(n[r[e]],i[s[e]]);if(0!==a)return a}return P(r.length,s.length)}(e.mapValue,t.mapValue);default:throw x()}}function t1(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return P(e,t);let n=tV(e),r=tV(t),i=P(n.seconds,r.seconds);return 0!==i?i:P(n.nanos,r.nanos)}function t2(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=t0(n[e],r[e]);if(t)return t}return P(n.length,r.length)}function t5(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tV(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tM(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Q.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=t5(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${t5(e.fields[i])}`;return n+"}"}(e.mapValue):x()}function t8(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function t4(e){return!!e&&"integerValue"in e}function t3(e){return!!e&&"arrayValue"in e}function t6(e){return!!e&&"nullValue"in e}function t9(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function t7(e){return!!e&&"mapValue"in e}function ne(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tG])||void 0===n?void 0:n.stringValue)===tH}function nt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tI(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nt(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function nn(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===tj}let nr={mapValue:{fields:{[tG]:{stringValue:tH},[tW]:{arrayValue:{}}}}};function ni(e,t){let n=t0(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ns(e,t){let n=t0(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class na{constructor(e){this.value=e}static empty(){return new na({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!t7(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nt(t)}setAll(e){let t=j.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nt(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());t7(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return tJ(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];t7(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tI(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new na(nt(this.value))}}class no{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new no(e,0,B.min(),B.min(),B.min(),na.empty(),0)}static newFoundDocument(e,t,n,r){return new no(e,1,t,B.min(),n,r,0)}static newNoDocument(e,t){return new no(e,2,t,B.min(),B.min(),na.empty(),0)}static newUnknownDocument(e,t){return new no(e,3,t,B.min(),B.min(),na.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(B.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=na.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=na.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof no&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new no(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nl{constructor(e,t){this.position=e,this.inclusive=t}}function nu(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?Q.comparator(Q.fromName(a.referenceValue),n.key):t0(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nh(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!tJ(e.position[n],t.position[n]))return!1;return!0}class nc{constructor(e,t="asc"){this.field=e,this.dir=t}}class nd{}class nf extends nd{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nI(e,t,n):"array-contains"===t?new nb(e,n):"in"===t?new nx(e,n):"not-in"===t?new nS(e,n):"array-contains-any"===t?new nN(e,n):new nf(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nT(e,n):new nE(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(t0(t,this.value)):null!==t&&tZ(this.value)===tZ(t)&&this.matchesComparison(t0(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nm extends nd{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new nm(e,t)}matches(e){return ng(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function ng(e){return"and"===e.op}function np(e){return"or"===e.op}function ny(e){return nw(e)&&ng(e)}function nw(e){for(let t of e.filters)if(t instanceof nm)return!1;return!0}function nv(e,t){let n=e.filters.concat(t);return nm.create(n,e.op)}class nI extends nf{constructor(e,t,n){super(e,t,n),this.key=Q.fromName(n.referenceValue)}matches(e){let t=Q.comparator(e.key,this.key);return this.matchesComparison(t)}}class nT extends nf{constructor(e,t){super(e,"in",t),this.keys=n_("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nE extends nf{constructor(e,t){super(e,"not-in",t),this.keys=n_("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function n_(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>Q.fromName(e.referenceValue))}class nb extends nf{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return t3(t)&&tX(t.arrayValue,this.value)}}class nx extends nf{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&tX(this.value.arrayValue,t)}}class nS extends nf{constructor(e,t){super(e,"not-in",t)}matches(e){if(tX(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!tX(this.value.arrayValue,t)}}class nN extends nf{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!t3(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>tX(this.value.arrayValue,e))}}class nD{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.le=null}}function nC(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nD(e,t,n,r,i,s,a)}function nk(e){if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nf)return t.field.canonicalString()+t.op.toString()+t5(t.value);if(ny(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eE(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>t5(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>t5(e)).join(",")),e.le=t}return e.le}function nA(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nf?n instanceof nf&&t.op===n.op&&t.field.isEqual(n.field)&&tJ(t.value,n.value):t instanceof nm?n instanceof nm&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void x()}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nh(e.startAt,t.startAt)&&nh(e.endAt,t.endAt)}function nV(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nR(e,t){return e.filters.filter(e=>e instanceof nf&&e.field.isEqual(t))}function nM(e,t,n){let r=tY,i=!0;for(let n of nR(e,t)){let e=tY,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?tY:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?t8(t$.empty(),Q.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?ne(s)?nr:{mapValue:{}}:x();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=tY}0>ni({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>ni({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function nO(e,t,n){let r=tQ,i=!0;for(let n of nR(e,t)){let e=tQ,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?t8(t$.empty(),Q.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nr:"mapValue"in s?ne(s)?{mapValue:{}}:tQ:x(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=tQ}ns({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];ns({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nL{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function nF(e){return new nL(e)}function nP(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nU(e){return null!==e.collectionGroup}function nq(e){if(null===e.he){let t;e.he=[];let n=new Set;for(let t of e.explicitOrderBy)e.he.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tx(j.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.he.push(new nc(t,r))}),n.has(j.keyField().canonicalString())||e.he.push(new nc(j.keyField(),r))}return e.he}function nB(e){return e.Pe||(e.Pe=nK(e,nq(e))),e.Pe}function nK(e,t){if("F"===e.limitType)return nC(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nc(e.field,t)});let n=e.endAt?new nl(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nl(e.startAt.position,e.startAt.inclusive):null;return nC(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function nz(e,t){let n=e.filters.concat([t]);return new nL(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function n$(e,t,n){return new nL(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function nG(e,t){return nA(nB(e),nB(t))&&e.limitType===t.limitType}function nj(e){return`${nk(nB(e))}|lt:${e.limitType}`}function nQ(e){var t;let n;return`Query(target=${n=(t=nB(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nf?`${t.field.canonicalString()} ${t.op} ${t5(t.value)}`:t instanceof nm?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eE(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>t5(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>t5(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function nH(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Q.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nq(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nu(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nq(e),t))&&(!e.endAt||!!function(e,t,n){let r=nu(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nq(e),t))}function nW(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function nY(e){return(t,n)=>{let r=!1;for(let i of nq(e)){let e=function(e,t,n){let r=e.field.isKeyField()?Q.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?t0(r,i):x()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return x()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class nZ{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tI(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tT(this.inner)}size(){return this.innerSize}}let nJ=new tE(Q.comparator),nX=new tE(Q.comparator);function n0(...e){let t=nX;for(let n of e)t=t.insert(n.key,n);return t}function n1(e){let t=nX;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function n2(){return new nZ(e=>e.toString(),(e,t)=>e.isEqual(t))}let n5=new tE(Q.comparator),n8=new tx(Q.comparator);function n4(...e){let t=n8;for(let n of e)t=t.add(n);return t}let n3=new tx(P);function n6(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e_(t)?"-0":t}}function n9(e){return{integerValue:""+e}}function n7(e,t){return eb(t)?n9(t):n6(e,t)}class re{constructor(){this._=void 0}}function rt(e,t){return e instanceof ro?t4(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rn extends re{}class rr extends re{constructor(e){super(),this.elements=e}}function ri(e,t){let n=ru(t);for(let t of e.elements)n.some(e=>tJ(e,t))||n.push(t);return{arrayValue:{values:n}}}class rs extends re{constructor(e){super(),this.elements=e}}function ra(e,t){let n=ru(t);for(let t of e.elements)n=n.filter(e=>!tJ(e,t));return{arrayValue:{values:n}}}class ro extends re{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function rl(e){return tR(e.integerValue||e.doubleValue)}function ru(e){return t3(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rh{constructor(e,t){this.field=e,this.transform=t}}class rc{constructor(e,t){this.version=e,this.transformResults=t}}class rd{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rd}static exists(e){return new rd(void 0,e)}static updateTime(e){return new rd(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rf(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rm{}function rg(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new r_(e.key,rd.none()):new rw(e.key,e.data,rd.none());{let n=e.data,r=na.empty(),i=new tx(j.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rv(e.key,r,new tD(i.toArray()),rd.none())}}function rp(e,t,n,r){return e instanceof rw?function(e,t,n,r){if(!rf(e.precondition,t))return n;let i=e.value.clone(),s=rE(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rv?function(e,t,n,r){if(!rf(e.precondition,t))return n;let i=rE(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rI(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rf(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function ry(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&U(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rr&&r instanceof rr||n instanceof rs&&r instanceof rs?U(n.elements,r.elements,tJ):n instanceof ro&&r instanceof ro?tJ(n.Ie,r.Ie):n instanceof rn&&r instanceof rn)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rw extends rm{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rv extends rm{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rI(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rT(e,t,n){var r;let i=new Map;e.length===n.length||x();for(let s=0;s<n.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(r=n[s],o instanceof rr?ri(o,l):o instanceof rs?ra(o,l):r))}return i}function rE(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rn?function(e,t){let n={fields:{[tL]:{stringValue:tO},[tP]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tU(t)&&(t=tq(t)),t&&(n.fields[tF]=t),{mapValue:n}}(t,s):e instanceof rr?ri(e,s):e instanceof rs?ra(e,s):function(e,t){let n=rt(e,t),r=rl(n)+rl(e.Ie);return t4(n)&&t4(e.Ie)?n9(r):n6(e.serializer,r)}(e,s))}return r}class r_ extends rm{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rb extends rm{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rx{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var r;r=n[t],i instanceof rw?function(e,t,n){let r=e.value.clone(),i=rT(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(i,e,r):i instanceof rv?function(e,t,n){if(!rf(e.precondition,t))return void t.convertToUnknownDocument(n.version);let r=rT(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rI(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(i,e,r):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,r)}}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rp(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rp(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=n2();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rg(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(B.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),n4())}isEqual(e){return this.batchId===e.batchId&&U(this.mutations,e.mutations,(e,t)=>ry(e,t))&&U(this.baseMutations,e.baseMutations,(e,t)=>ry(e,t))}}class rS{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){e.mutations.length===n.length||x();let r=n5,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rS(e,t,n,r)}}class rN{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rD{constructor(e,t){this.count=e,this.unchangedNames=t}}function rC(e){switch(e){case S.OK:return x();case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0;default:return x()}}function rk(e){if(void 0===e)return E("GRPC error has no .code"),S.UNKNOWN;switch(e){case r.OK:return S.OK;case r.CANCELLED:return S.CANCELLED;case r.UNKNOWN:return S.UNKNOWN;case r.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case r.INTERNAL:return S.INTERNAL;case r.UNAVAILABLE:return S.UNAVAILABLE;case r.UNAUTHENTICATED:return S.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case r.NOT_FOUND:return S.NOT_FOUND;case r.ALREADY_EXISTS:return S.ALREADY_EXISTS;case r.PERMISSION_DENIED:return S.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case r.ABORTED:return S.ABORTED;case r.OUT_OF_RANGE:return S.OUT_OF_RANGE;case r.UNIMPLEMENTED:return S.UNIMPLEMENTED;case r.DATA_LOSS:return S.DATA_LOSS;default:return x()}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rA=new c.jz([0xffffffff,0xffffffff],0);function rV(e){let t=(new TextEncoder).encode(e),n=new c.VV;return n.update(t),new Uint8Array(n.digest())}function rR(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([n,r],0),new c.jz([i,s],0)]}class rM{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rO(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rO(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rO(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=c.jz.fromNumber(this.Ee)}Ae(e,t,n){let r=e.add(t.multiply(c.jz.fromNumber(n)));return 1===r.compare(rA)&&(r=new c.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;let[t,n]=rR(rV(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);if(!this.Re(r))return!1}return!0}static create(e,t,n){let r=new rM(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.Ee)return;let[t,n]=rR(rV(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);this.Ve(r)}}Ve(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rO extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rL{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rF.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rL(B.min(),r,new tE(P),nJ,n4())}}class rF{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rF(n,t,n4(),n4(),n4())}}class rP{constructor(e,t,n,r){this.me=e,this.removedTargetIds=t,this.key=n,this.fe=r}}class rU{constructor(e,t){this.targetId=e,this.ge=t}}class rq{constructor(e,t,n=tk.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rB{constructor(){this.pe=0,this.ye=r$(),this.we=tk.EMPTY_BYTE_STRING,this.be=!1,this.Se=!0}get current(){return this.be}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.Se}Ce(e){e.approximateByteSize()>0&&(this.Se=!0,this.we=e)}Fe(){let e=n4(),t=n4(),n=n4();return this.ye.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:x()}}),new rF(this.we,this.be,e,t,n)}Me(){this.Se=!1,this.ye=r$()}xe(e,t){this.Se=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.Se=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,this.pe>=0||x()}Le(){this.Se=!0,this.be=!0}}class rK{constructor(e){this.ke=e,this.qe=new Map,this.Qe=nJ,this.$e=rz(),this.Ke=rz(),this.Ue=new tE(P)}We(e){for(let t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(let t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,t=>{let n=this.He(t);switch(e.state){case 0:this.Je(t)&&n.Ce(e.resumeToken);break;case 1:n.Be(),n.De||n.Me(),n.Ce(e.resumeToken);break;case 2:n.Be(),n.De||this.removeTarget(t);break;case 3:this.Je(t)&&(n.Le(),n.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),n.Ce(e.resumeToken));break;default:x()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach((e,n)=>{this.Je(n)&&t(n)})}Ze(e){let t=e.targetId,n=e.ge.count,r=this.Xe(t);if(r){let i=r.target;if(nV(i)){if(0===n){let e=new Q(i.path);this.ze(t,e,no.newNoDocument(e,B.min()))}else 1===n||x()}else{let r=this.et(t);if(r!==n){let n=this.tt(e),i=n?this.nt(n,e,r):1;0!==i&&(this.Ye(t),this.Ue=this.Ue.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}tt(e){let t,n;let r=e.ge.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=tM(i).toUint8Array()}catch(e){if(e instanceof tC)return _("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new rM(t,s,a)}catch(e){return _(e instanceof rO?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.Ee?null:n}nt(e,t,n){return 2*(t.ge.count!==n-this.st(e,t.targetId))}st(e,t){let n=this.ke.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.ke.it(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.ze(t,n,null),r++)}),r}ot(e){let t=new Map;this.qe.forEach((n,r)=>{let i=this.Xe(r);if(i){if(n.current&&nV(i.target)){let t=new Q(i.target.path);this._t(t).has(r)||this.ut(r,t)||this.ze(r,t,no.newNoDocument(t,e))}n.ve&&(t.set(r,n.Fe()),n.Me())}});let n=n4();this.Ke.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.Qe.forEach((t,n)=>n.setReadTime(e));let r=new rL(e,t,this.Ue,this.Qe,n);return this.Qe=nJ,this.$e=rz(),this.Ke=rz(),this.Ue=new tE(P),r}Ge(e,t){if(!this.Je(e))return;let n=2*!!this.ut(e,t.key);this.He(e).xe(t.key,n),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ke=this.Ke.insert(t.key,this.ct(t.key).add(e))}ze(e,t,n){if(!this.Je(e))return;let r=this.He(e);this.ut(e,t)?r.xe(t,1):r.Oe(t),this.Ke=this.Ke.insert(t,this.ct(t).delete(e)),this.Ke=this.Ke.insert(t,this.ct(t).add(e)),n&&(this.Qe=this.Qe.insert(t,n))}removeTarget(e){this.qe.delete(e)}et(e){let t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new rB,this.qe.set(e,t)),t}ct(e){let t=this.Ke.get(e);return t||(t=new tx(P),this.Ke=this.Ke.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new tx(P),this.$e=this.$e.insert(e,t)),t}Je(e){let t=null!==this.Xe(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){let t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new rB),this.ke.getRemoteKeysForTarget(e).forEach(t=>{this.ze(e,t,null)})}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function rz(){return new tE(Q.comparator)}function r$(){return new tE(Q.comparator)}let rG={asc:"ASCENDING",desc:"DESCENDING"},rj={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},rQ={and:"AND",or:"OR"};class rH{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function rW(e,t){return e.useProto3Json||eE(t)?t:{value:t}}function rY(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function rZ(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function rJ(e){return e||x(),B.fromTimestamp(function(e){let t=tV(e);return new q(t.seconds,t.nanos)}(e))}function rX(e,t){return r0(e,t).canonicalString()}function r0(e,t){let n=new $(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function r1(e){let t=$.fromString(e);return il(t)||x(),t}function r2(e,t){return rX(e.databaseId,t.path)}function r5(e,t){let n=r1(t);if(n.get(1)!==e.databaseId.projectId)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Q(r6(n))}function r8(e,t){return rX(e.databaseId,t)}function r4(e){let t=r1(e);return 4===t.length?$.emptyPath():r6(t)}function r3(e){return new $(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function r6(e){return e.length>4&&"documents"===e.get(4)||x(),e.popFirst(5)}function r9(e,t,n){return{name:r2(e,t),fields:n.value.mapValue.fields}}function r7(e,t,n){let r=r5(e,t.name),i=rJ(t.updateTime),s=t.createTime?rJ(t.createTime):B.min(),a=new na({mapValue:{fields:t.fields}}),o=no.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ie(e,t){var n;let r;if(t instanceof rw)r={update:r9(e,t.key,t.value)};else if(t instanceof r_)r={delete:r2(e,t.key)};else if(t instanceof rv)r={update:r9(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rb))return x();r={verify:r2(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rn)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rs)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof ro)return{fieldPath:t.field.canonicalString(),increment:n.Ie};throw x()})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:rY(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:x()),r}function it(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rd.updateTime(rJ(n.updateTime)):void 0!==n.exists?rd.exists(n.exists):rd.none():rd.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{var n,r;let i;return n=e,i=null,"setToServerValue"in(r=t)?("REQUEST_TIME"===r.setToServerValue||x(),i=new rn):"appendMissingElements"in r?i=new rr(r.appendMissingElements.values||[]):"removeAllFromArray"in r?i=new rs(r.removeAllFromArray.values||[]):"increment"in r?i=new ro(n,r.increment):x(),new rh(j.fromServerFormat(r.fieldPath),i)}):[];if(t.update){t.update.name;let n=r5(e,t.update.name),s=new na({mapValue:{fields:t.update.fields}});return t.updateMask?new rv(n,s,new tD((t.updateMask.fieldPaths||[]).map(e=>j.fromServerFormat(e))),r,i):new rw(n,s,r,i)}return t.delete?new r_(r5(e,t.delete),r):t.verify?new rb(r5(e,t.verify),r):x()}function ir(e,t){return{documents:[r8(e,t.path)]}}function ii(e,t){var n,r;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=r8(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof nf?function(e){if("=="===e.op){if(t9(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NAN"}};if(t6(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(t9(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NOT_NAN"}};if(t6(e.value))return{unaryFilter:{field:ia(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ia(e.field),op:rj[e.op],value:e.value}}}(t):t instanceof nm?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:rQ[t.op],filters:n}}}(t):x()}(nm.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:ia(e.field),direction:rG[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=rW(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ht:s,parent:i}}function is(e){var t;let n,r=r4(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||x();let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=io(e.unaryFilter.field);return nf.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=io(e.unaryFilter.field);return nf.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=io(e.unaryFilter.field);return nf.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=io(e.unaryFilter.field);return nf.create(i,"!=",{nullValue:"NULL_VALUE"});default:return x()}}(t):void 0!==t.fieldFilter?nf.create(io(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return x()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nm.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x()}}(t.compositeFilter.op)):x()}(e);return t instanceof nm&&ny(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nc(io(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eE(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new nl(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new nl(e.values||[],t)}(i.endAt)),new nL(r,a,l,o,u,"F",h,c)}function ia(e){return{fieldPath:e.canonicalString()}}function io(e){return j.fromServerFormat(e.fieldPath)}function il(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iu{constructor(e,t,n,r,i=B.min(),s=B.min(),a=tk.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ih{constructor(e){this.Tt=e}}function ic(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:id(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:r2(i=e.Tt,t.key),fields:t.data.value.mapValue.fields,updateTime:rY(i,t.version.toTimestamp()),createTime:rY(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:im(t.version)};else{if(!t.isUnknownDocument())return x();r.unknownDocument={path:n.path.toArray(),version:im(t.version)}}return r}function id(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function im(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ig(e){let t=new q(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function ip(e,t){let n=(t.baseMutations||[]).map(t=>it(e.Tt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){let r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}let r=t.mutations.map(t=>it(e.Tt,t)),i=q.fromMillis(t.localWriteTimeMs);return new rx(t.batchId,i,n,r)}function iy(e){var t;let n=ig(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ig(e.lastLimboFreeSnapshotVersion):B.min();return new iu(void 0!==e.query.documents?(1===(t=e.query).documents.length||x(),nB(nF(r4(t.documents[0])))):nB(is(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,tk.fromBase64String(e.resumeToken))}function iw(e,t){let n;let r=im(t.snapshotVersion),i=im(t.lastLimboFreeSnapshotVersion);n=nV(t.target)?ir(e.Tt,t.target):ii(e.Tt,t.target).ht;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nk(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iv(e){let t=is({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?n$(t,t.limit,"L"):t}function iI(e,t){return new rN(t.largestBatchId,it(e.Tt,t.overlayMutation))}function iT(e,t){let n=t.path.lastSegment();return[e,ex(t.path.popLast()),n]}function iE(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:im(r.readTime),documentKey:ex(r.documentKey.path),largestBatchId:r.largestBatchId}}class i_{getBundleMetadata(e,t){return tw(e,e5).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:ig(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tw(e,e5).put({bundleId:t.id,createTime:im(rJ(t.createTime)),version:t.version})}getNamedQuery(e,t){return tw(e,e8).get(t).next(e=>{if(e)return{name:e.name,query:iv(e.bundledQuery),readTime:ig(e.readTime)}})}saveNamedQuery(e,t){return tw(e,e8).put({name:t.name,readTime:im(rJ(t.readTime)),bundledQuery:t.bundledQuery})}}class ib{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){return new ib(e,t.uid||"")}getOverlay(e,t){return tw(e,ts).get(iT(this.userId,t)).next(e=>e?iI(this.serializer,e):null)}getOverlays(e,t){let n=n2();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rN(t,i);r.push(this.Et(e,s))}),ea.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(ex(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tw(e,ts).J(to,r))}),ea.waitFor(i)}getOverlaysForCollection(e,t,n){let r=n2(),i=ex(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tw(e,ts).G(to,s).next(e=>{for(let t of e){let e=iI(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i;let s=n2(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tw(e,ts).Z({index:tu,range:a},(e,t,n)=>{let a=iI(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}Et(e,t){return tw(e,ts).put(function(e,t,n){let[r,i,s]=iT(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ie(e.Tt,n.mutation)}}(this.serializer,this.userId,t))}}class ix{dt(e){return tw(e,tc)}getSessionToken(e){return this.dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tk.fromUint8Array(t):tk.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iS{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(+!!e.booleanValue);else if("integerValue"in e)this.ft(t,15),t.gt(tR(e.integerValue));else if("doubleValue"in e){let n=tR(e.doubleValue);isNaN(n)?this.ft(t,13):(this.ft(t,15),e_(n)?t.gt(0):t.gt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.ft(t,20),"string"==typeof n&&(n=tV(n)),t.yt(`${n.seconds||""}`),t.gt(n.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.bt(t);else if("bytesValue"in e)this.ft(t,30),t.St(tM(e.bytesValue)),this.bt(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.ft(t,45),t.gt(n.latitude||0),t.gt(n.longitude||0)}else"mapValue"in e?nn(e)?this.ft(t,Number.MAX_SAFE_INTEGER):ne(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.bt(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.bt(t)):x()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){let n=e.fields||{};for(let e of(this.ft(t,55),Object.keys(n)))this.wt(e,t),this.Rt(n[e],t)}vt(e,t){var n,r;let i=e.fields||{};this.ft(t,53);let s=(null===(r=null===(n=i[tW].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.ft(t,15),t.gt(tR(s)),this.wt(tW,t),this.Rt(i[tW],t)}Ft(e,t){let n=e.values||[];for(let e of(this.ft(t,50),n))this.Rt(e,t)}Dt(e,t){this.ft(t,37),Q.fromName(e).path.forEach(e=>{this.ft(t,60),this.Mt(e,t)})}ft(e,t){e.gt(t)}bt(e){e.gt(2)}}function iN(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iS.xt=new iS;class iD{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Nt(n.value),n=t.next();this.Bt()}Lt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.kt(n.value),n=t.next();this.qt()}Qt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{let e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{let e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Kt(e){let t=this.Ut(e),n=iN(t);this.Wt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Gt(e){let t=this.Ut(e),n=iN(t);this.Wt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}zt(){this.jt(255),this.jt(255)}Ht(){this.Jt(255),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Ut(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}Nt(e){let t=255&e;0===t?(this.jt(0),this.jt(255)):255===t?(this.jt(255),this.jt(0)):this.jt(t)}kt(e){let t=255&e;0===t?(this.Jt(0),this.Jt(255)):255===t?(this.Jt(255),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iC{constructor(e){this.Zt=e}St(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Kt(e)}Vt(){this.Zt.zt()}}class ik{constructor(e){this.Zt=e}St(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class iA{constructor(){this.Zt=new iD,this.Xt=new iC(this.Zt),this.en=new ik(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class iV{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}nn(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new iV(this.indexId,this.documentKey,this.arrayValue,n)}}function iR(e,t){let n=e.indexId-t.indexId;return 0!==n?n:0!==(n=iM(e.arrayValue,t.arrayValue))?n:0!==(n=iM(e.directionalValue,t.directionalValue))?n:Q.comparator(e.documentKey,t.documentKey)}function iM(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class iO{constructor(e){for(let t of(this.rn=new tx((e,t)=>j.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[],e.filters))t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}get an(){return this.rn.size>1}un(e){if(e.collectionGroup===this.collectionId||x(),this.an)return!1;let t=W(e);if(void 0!==t&&!this.cn(t))return!1;let n=Y(e),r=new Set,i=0,s=0;for(;i<n.length&&this.cn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.rn.size>0){let e=this.rn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.ln(e,t)||!this.hn(this.sn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.sn.length||!this.hn(this.sn[s++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new tx(j.comparator),t=[];for(let n of this._n)if(!n.field.isKeyField()){if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new Z(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new Z(n.field,0))}}for(let n of this.sn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new Z(n.field,+("asc"!==n.dir))));return new H(H.UNKNOWN_ID,this.collectionId,t,J.empty())}cn(e){for(let t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iL(e){return e instanceof nf}function iF(e){return e instanceof nm&&ny(e)}function iP(e){return iL(e)||iF(e)||function(e){if(e instanceof nm&&np(e)){for(let t of e.getFilters())if(!iL(t)&&!iF(t))return!1;return!0}return!1}(e)}function iU(e,t){return e instanceof nf||e instanceof nm||x(),t instanceof nf||t instanceof nm||x(),iB(e instanceof nf?t instanceof nf?nm.create([e,t],"and"):iq(e,t):t instanceof nf?iq(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||x(),ng(e)&&ng(t))return nv(e,t.getFilters());let n=np(e)?e:t,r=np(e)?t:e,i=n.filters.map(e=>iU(e,r));return nm.create(i,"or")}(e,t))}function iq(e,t){if(ng(t))return nv(t,e.getFilters());{let n=t.filters.map(t=>iU(e,t));return nm.create(n,"or")}}function iB(e){if(e instanceof nf||e instanceof nm||x(),e instanceof nf)return e;let t=e.getFilters();if(1===t.length)return iB(t[0]);if(nw(e))return e;let n=t.map(e=>iB(e)),r=[];return n.forEach(t=>{t instanceof nf?r.push(t):t instanceof nm&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nm.create(r,e.op)}class iK{constructor(){this.Tn=new iz}addToCollectionParentIndex(e,t){return this.Tn.add(t),ea.resolve()}getCollectionParents(e,t){return ea.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return ea.resolve()}deleteFieldIndex(e,t){return ea.resolve()}deleteAllFieldIndexes(e){return ea.resolve()}createTargetIndexes(e,t){return ea.resolve()}getDocumentsMatchingTarget(e,t){return ea.resolve(null)}getIndexType(e,t){return ea.resolve(0)}getFieldIndexes(e,t){return ea.resolve([])}getNextCollectionGroupToUpdate(e){return ea.resolve(null)}getMinOffset(e,t){return ea.resolve(et.min())}getMinOffsetFromCollectionGroup(e,t){return ea.resolve(et.min())}updateCollectionGroup(e,t,n){return ea.resolve()}updateIndexEntries(e,t){return ea.resolve()}}class iz{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tx($.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tx($.comparator)).toArray()}}let i$="IndexedDbIndexManager",iG=new Uint8Array(0);class ij{constructor(e,t){this.databaseId=t,this.In=new iz,this.En=new nZ(e=>nk(e),(e,t)=>nA(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.In.add(t)});let i={collectionId:n,parent:ex(r)};return tw(e,e0).put(i)}return ea.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tw(e,e0).G(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eS(r.parent))}return n})}addFieldIndex(e,t){let n=tw(e,e4),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tw(e,e6);return i.next(e=>{n.put(iE(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tw(e,e4),r=tw(e,e6),i=tw(e,tt);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tw(e,e4),n=tw(e,tt),r=tw(e,e6);return t.J().next(()=>n.J()).next(()=>r.J())}createTargetIndexes(e,t){return ea.forEach(this.dn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iO(t).Pn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tw(e,tt),r=!0,i=new Map;return ea.forEach(this.dn(t),t=>this.An(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=n4(),r=[];return ea.forEach(i,(i,s)=>{T(i$,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nk(t)}`);let a=function(e,t){let n=W(t);if(void 0===n)return null;for(let t of nR(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of Y(t))for(let t of nR(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of Y(t)){let t=0===i.kind?nM(e,i.fieldPath,e.startAt):nO(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nl(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of Y(t)){let t=0===i.kind?nO(e,i.fieldPath,e.endAt):nM(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nl(n,r)}(s,i),h=this.Rn(i,s,l),c=this.Rn(i,s,u),d=this.Vn(i,s,o),f=this.mn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ea.forEach(f,i=>n.H(i,t.limit).next(t=>{t.forEach(t=>{let n=Q.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ea.resolve(null)})}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof nf||t instanceof nm||x(),t instanceof nf)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nm.create(n,t.op);return iP(r=iB(r))?r:(r instanceof nm||x(),ng(r)||x(),r.filters.length>1||x(),r.filters.reduce((e,t)=>iU(e,t)))}(function e(t){var n,r;if(t instanceof nf||t instanceof nm||x(),t instanceof nf){if(t instanceof nx){let e=(null===(r=null===(n=t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>nf.create(t.field,"==",e)))||[];return nm.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return nm.create(i,t.op)}(e));return iP(t)||x(),iL(t)||iF(t)?[t]:t.getFilters()})(nm.create(e.filters,"and")).map(t=>nC(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.En.set(e,t)),t}mn(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.fn(t[h/l]):iG,c=this.gn(e,o,n[h%l],r),d=this.pn(e,o,i[h%l],s),f=a.map(t=>this.gn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}gn(e,t,n,r){let i=new iV(e,Q.empty(),t,n);return r?i:i.nn()}pn(e,t,n,r){let i=new iV(e,Q.empty(),t,n);return r?i.nn():i}An(e,t){let n=new iO(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.un(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.dn(t);return ea.forEach(r,t=>this.An(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tx(j.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}yn(e,t){let n=new iA;for(let r of Y(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.tn(r.kind);iS.xt.At(e,i)}return n.Yt()}fn(e){let t=new iA;return iS.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){let n=new iA;return iS.xt.At(t8(this.databaseId,t),n.tn(function(e){let t=Y(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Yt()}Vn(e,t,n){if(null===n)return[];let r=[];r.push(new iA);let i=0;for(let s of Y(e)){let e=n[i++];for(let n of r)if(this.bn(t,s.fieldPath)&&t3(e))r=this.Sn(r,s,e);else{let t=n.tn(s.kind);iS.xt.At(e,t)}}return this.Dn(r)}Rn(e,t,n){return this.Vn(e,t,n.position)}Dn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Yt();return t}Sn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new iA;r.seed(n.Yt()),iS.xt.At(e,r.tn(t.kind)),i.push(r)}return i}bn(e,t){return!!e.filters.find(e=>e instanceof nf&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tw(e,e4),r=tw(e,e6);return(t?n.G(e3,IDBKeyRange.bound(t,t)):n.G()).next(e=>{let t=[];return ea.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new J(t.sequenceNumber,new et(ig(t.readTime),new Q(eS(t.documentKey)),t.largestBatchId)):J.empty(),r=e.fields.map(([e,t])=>new Z(j.fromServerFormat(e),t));return new H(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:P(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tw(e,e4),i=tw(e,e6);return this.vn(e).next(e=>r.G(e3,IDBKeyRange.bound(t,t)).next(t=>ea.forEach(t,t=>i.put(iE(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ea.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ea.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ea.forEach(i,n=>this.Cn(e,t,n).next(t=>{let i=this.Fn(r,n);return t.isEqual(i)?ea.resolve():this.Mn(e,r,n,t,i)}))))})}xn(e,t,n,r){return tw(e,tt).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.wn(n,t.key),documentKey:t.key.path.toArray()})}On(e,t,n,r){return tw(e,tt).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.wn(n,t.key),t.key.path.toArray()])}Cn(e,t,n){let r=tw(e,tt),i=new tx(iR);return r.Z({index:tr,range:IDBKeyRange.only([n.indexId,this.uid,this.wn(n,t)])},(e,r)=>{i=i.add(new iV(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}Fn(e,t){let n=new tx(iR),r=this.yn(t,e);if(null==r)return n;let i=W(t);if(null!=i){let s=e.data.field(i.fieldPath);if(t3(s))for(let i of s.arrayValue.values||[])n=n.add(new iV(t.indexId,e.key,this.fn(i),r))}else n=n.add(new iV(t.indexId,e.key,iG,r));return n}Mn(e,t,n,r,i){T(i$,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tN(s),l=tN(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tN(a)):t?(i(o),o=tN(s)):(o=tN(s),l=tN(a))}}(r,i,iR,r=>{s.push(this.xn(e,t,n,r))},r=>{s.push(this.On(e,t,n,r))}),ea.waitFor(s)}vn(e){let t=1;return tw(e,e6).Z({index:e7,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>iR(e,t)).filter((e,t,n)=>!t||0!==iR(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=iR(i,e),s=iR(i,t);if(0===n)r[0]=e.nn();else if(n>0&&s<0)r.push(i),r.push(i.nn());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Nn(r[e],r[e+1]))return[];let t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,iG,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,iG,[]];i.push(IDBKeyRange.bound(t,n))}return i}Nn(e,t){return iR(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(iQ)}getMinOffset(e,t){return ea.mapArray(this.dn(t),t=>this.An(e,t).next(e=>e||x())).next(iQ)}}function iQ(e){0!==e.length||x();let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>en(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new et(t.readTime,t.documentKey,n)}let iH={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class iW{static withCacheSize(e){return new iW(e,iW.DEFAULT_COLLECTION_PERCENTILE,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function iY(e,t,n){let r=e.store(eA),i=e.store(eL),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{1===o||x()}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,ex(h),c]);s.push(i.delete(r)),u.push(e.key)}return ea.waitFor(s).next(()=>u)}function iZ(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x();t=e.noDocument}return JSON.stringify(t).length}iW.DEFAULT_COLLECTION_PERCENTILE=10,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,iW.DEFAULT=new iW(0x2800000,iW.DEFAULT_COLLECTION_PERCENTILE,iW.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),iW.DISABLED=new iW(-1,0,0);class iJ{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Bn={}}static It(e,t,n,r){return""!==e.uid||x(),new iJ(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return i0(e).Z({index:eR,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tw(e,eL),s=i0(e);return s.add({}).next(a=>{var o;"number"==typeof a||x();let l=new rx(a,t,n,r),u=function(e,t,n){let r=n.baseMutations.map(t=>ie(e.Tt,t)),i=n.mutations.map(t=>ie(e.Tt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,l),h=[],c=new tx((e,t)=>P(e.canonicalString(),t.canonicalString()));for(let e of r){let t=(o=this.userId,[o,ex(e.key.path),a]);c=c.add(e.key.path.popLast()),h.push(s.put(u)),h.push(i.put(t,eO))}return c.forEach(t=>{h.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Bn[a]=l.keys()}),ea.waitFor(h).next(()=>l)})}lookupMutationBatch(e,t){return i0(e).get(t).next(e=>e?(e.userId===this.userId||x(),ip(this.serializer,e)):null)}Ln(e,t){return this.Bn[t]?ea.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Bn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return i0(e).Z({index:eR,range:r},(e,t,r)=>{t.userId===this.userId&&(t.batchId>=n||x(),i=ip(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return i0(e).Z({index:eR,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return i0(e).G(eR,t).next(e=>e.map(e=>ip(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,ex(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tw(e,eL).Z({range:r},(n,r,s)=>{let[a,o,l]=n,u=eS(o);if(a===this.userId&&t.path.isEqual(u))return i0(e).get(l).next(e=>{if(!e)throw x();e.userId===this.userId||x(),i.push(ip(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tx(P),r=[];return t.forEach(t=>{let i=[this.userId,ex(t.path)],s=IDBKeyRange.lowerBound(i),a=tw(e,eL).Z({range:s},(e,r,i)=>{let[s,a,o]=e,l=eS(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ea.waitFor(r).next(()=>this.kn(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,ex(n)],s=IDBKeyRange.lowerBound(i),a=new tx(P);return tw(e,eL).Z({range:s},(e,t,i)=>{let[s,o,l]=e,u=eS(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.kn(e,a))}kn(e,t){let n=[],r=[];return t.forEach(t=>{r.push(i0(e).get(t).next(e=>{if(null===e)throw x();e.userId===this.userId||x(),n.push(ip(this.serializer,e))}))}),ea.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return iY(e.ue,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.qn(t.batchId)}),ea.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ea.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tw(e,eL).Z({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eS(e[1]);r.push(t)}else n.done()}).next(()=>{0===r.length||x()})})}containsKey(e,t){return iX(e,this.userId,t)}Qn(e){return tw(e,ek).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function iX(e,t,n){let r=[t,ex(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tw(e,eL).Z({range:s,Y:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function i0(e){return tw(e,eA)}class i1{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Kn(){return new i1(0)}static Un(){return new i1(-1)}}class i2{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next(t=>{let n=new i1(t.highestTargetId);return t.highestTargetId=n.next(),this.Gn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Wn(e).next(e=>B.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Wn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.Wn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Gn(e,r)))}addTargetData(e,t){return this.zn(e,t).next(()=>this.Wn(e).next(n=>(n.targetCount+=1,this.jn(t,n),this.Gn(e,n))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tw(e,eG).delete(t.targetId)).next(()=>this.Wn(e)).next(t=>(t.targetCount>0||x(),t.targetCount-=1,this.Gn(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tw(e,eG).Z((s,a)=>{let o=iy(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ea.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tw(e,eG).Z((e,n)=>{t(iy(n))})}Wn(e){return tw(e,eX).get(eJ).next(e=>(null!==e||x(),e))}Gn(e,t){return tw(e,eX).put(eJ,t)}zn(e,t){return tw(e,eG).put(iw(this.serializer,t))}jn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Wn(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nk(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tw(e,eG).Z({range:r,index:ej},(e,n,r)=>{let s=iy(n);nA(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=i5(e);return t.forEach(t=>{let s=ex(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ea.waitFor(r)}removeMatchingKeys(e,t,n){let r=i5(e);return ea.forEach(t,t=>{let i=ex(t.path);return ea.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=i5(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=i5(e),i=n4();return r.Z({range:n,Y:!0},(e,t,n)=>{let r=new Q(eS(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=ex(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return i5(e).Z({index:eY,Y:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}lt(e,t){return tw(e,eG).get(t).next(e=>e?iy(e):null)}}function i5(e){return tw(e,eH)}let i8="LruGarbageCollector";function i4([e,t],[n,r]){let i=P(e,n);return 0===i?P(t,r):i}class i3{constructor(e){this.Hn=e,this.buffer=new tx(i4),this.Jn=0}Yn(){return++this.Jn}Zn(e){let t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>i4(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class i6{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){T(i8,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ef(e)?T(i8,"Ignoring IndexedDB error during garbage collection: ",e):await es(e)}await this.er(3e5)})}}class i9{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ea.resolve(eT.ae);let n=new i3(t);return this.tr.forEachTarget(e,e=>n.Zn(e.sequenceNumber)).next(()=>this.tr.rr(e,e=>n.Zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.tr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),ea.resolve(iH)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),iH):this.ir(e,t))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let n,r,i,s,a,o,l;let h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),ea.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class i7{constructor(e,t){this.db=e,this.garbageCollector=new i9(this,t)}nr(e){let t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,(e,n)=>t(n))}addReference(e,t,n){return se(e,n)}removeReference(e,t,n){return se(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return se(e,t)}ar(e,t){let n;return n=!1,tw(e,ek).X(r=>iX(e,r,t).next(e=>(e&&(n=!0),ea.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this._r(e,(s,a)=>{if(a<=t){let t=this.ar(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,B.min()),i5(e).delete([0,ex(s.path)])))});r.push(t)}}).next(()=>ea.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return se(e,t)}_r(e,t){let n=i5(e),r,i=eT.ae;return n.Z({index:eY},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==eT.ae&&t(new Q(eS(r)),i),i=a,r=s):i=eT.ae}).next(()=>{i!==eT.ae&&t(new Q(eS(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function se(e,t){var n;return i5(e).put((n=e.currentSequenceNumber,{targetId:0,path:ex(t.path),sequenceNumber:n}))}class st{constructor(){this.changes=new nZ(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,no.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ea.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sn{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tw(e,eF).put(n)}removeEntry(e,t,n){return tw(e,eF).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],id(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.ur(e,n)))}getEntry(e,t){let n=no.newInvalidDocument(t);return tw(e,eF).Z({index:eU,range:IDBKeyRange.only(si(t))},(e,r)=>{n=this.cr(t,r)}).next(()=>n)}lr(e,t){let n={size:0,document:no.newInvalidDocument(t)};return tw(e,eF).Z({index:eU,range:IDBKeyRange.only(si(t))},(e,r)=>{n={document:this.cr(t,r),size:iZ(r)}}).next(()=>n)}getEntries(e,t){let n=nJ;return this.hr(e,t,(e,t)=>{let r=this.cr(e,t);n=n.insert(e,r)}).next(()=>n)}Pr(e,t){let n=nJ,r=new tE(Q.comparator);return this.hr(e,t,(e,t)=>{let i=this.cr(e,t);n=n.insert(e,i),r=r.insert(e,iZ(t))}).next(()=>({documents:n,Tr:r}))}hr(e,t,n){if(t.isEmpty())return ea.resolve();let r=new tx(sa);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(si(r.first()),si(r.last())),s=r.getIterator(),a=s.getNext();return tw(e,eF).Z({index:eU,range:i},(e,t,r)=>{let i=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sa(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.W(si(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),id(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tw(e,eF).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=nJ;for(let i of e){let e=this.cr(Q.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(nH(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=nJ,s=ss(t,n),a=ss(t,et.max());return tw(e,eF).Z({index:eB,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.cr(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sr(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tw(e,ez).get(e$).next(e=>(e||x(),e))}ur(e,t){return tw(e,ez).put(e$,t)}cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=r7(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Q.fromSegments(t.noDocument.path),r=ig(t.noDocument.readTime);n=no.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return x();{let e=Q.fromSegments(t.unknownDocument.path),r=ig(t.unknownDocument.version);n=no.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new q(e[0],e[1]);return B.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(B.min())))return e}return no.newInvalidDocument(e)}}class sr extends st{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new nZ(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tx((e,t)=>P(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Er.get(i);if(t.push(this.Ir.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=ic(this.Ir.serializer,s);r=r.add(i.path.popLast());let l=iZ(o);n+=l-a.size,t.push(this.Ir.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=ic(this.Ir.serializer,s.convertToNoDocument(B.min()));t.push(this.Ir.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Ir.updateMetadata(e,n)),ea.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next(e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next(({documents:e,Tr:t})=>(t.forEach((t,n)=>{this.Er.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function si(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function ss(e,t){let n=t.documentKey.path.toArray();return[e,id(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sa(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=P(n[e],r[e]))return i;return(i=P(n.length,r.length))||(i=P(n[n.length-2],r[r.length-2]))||P(n[n.length-1],r[r.length-1])}class so{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sl{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rp(n.mutation,e,tD.empty(),q.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,n4()).next(()=>t))}getLocalViewOfDocuments(e,t,n=n4()){let r=n2();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=n0();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=n2();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,n4()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=nJ,s=n2(),a=n2();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rv)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rp(a.mutation,t,a.mutation.getFieldMask(),q.now())):s.set(t.key,tD.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new so(t,null!==(n=s.get(e))&&void 0!==n?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=n2(),r=new tE((e,t)=>e-t),i=n4();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tD.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||n4()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=n2();l.forEach(e=>{if(!i.has(e)){let r=rg(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ea.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return Q.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nU(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ea.resolve(n2()),a=-1,o=i;return s.next(t=>ea.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ea.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,n4())).next(e=>({batchId:a,changes:n1(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next(e=>{let t=n0();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=n0();return this.indexManager.getCollectionParents(e,i).next(a=>ea.forEach(a,a=>{let o=new nL(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,no.newInvalidDocument(r)))});let n=n0();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rp(s.mutation,r,tD.empty(),q.now()),nH(t,r)&&(n=n.insert(e,r))}),n})}}class su{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return ea.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,{id:t.id,version:t.version,createTime:rJ(t.createTime)}),ea.resolve()}getNamedQuery(e,t){return ea.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,{name:t.name,query:iv(t.bundledQuery),readTime:rJ(t.readTime)}),ea.resolve()}}class sh{constructor(){this.overlays=new tE(Q.comparator),this.Rr=new Map}getOverlay(e,t){return ea.resolve(this.overlays.get(t))}getOverlays(e,t){let n=n2();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.Et(e,t,r)}),ea.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Rr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Rr.delete(n)),ea.resolve()}getOverlaysForCollection(e,t,n){let r=n2(),i=t.length+1,s=new Q(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ea.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tE((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=n2(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=n2(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ea.resolve(a)}Et(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Rr.get(r.largestBatchId).delete(n.key);this.Rr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rN(t,n));let i=this.Rr.get(t);void 0===i&&(i=n4(),this.Rr.set(t,i)),this.Rr.set(t,i.add(n.key))}}class sc{constructor(){this.sessionToken=tk.EMPTY_BYTE_STRING}getSessionToken(e){return ea.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ea.resolve()}}class sd{constructor(){this.Vr=new tx(sf.mr),this.gr=new tx(sf.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){let n=new sf(e,t);this.Vr=this.Vr.add(n),this.gr=this.gr.add(n)}yr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.wr(new sf(e,t))}br(e,t){e.forEach(e=>this.removeReference(e,t))}Sr(e){let t=new Q(new $([])),n=new sf(t,e),r=new sf(t,e+1),i=[];return this.gr.forEachInRange([n,r],e=>{this.wr(e),i.push(e.key)}),i}Dr(){this.Vr.forEach(e=>this.wr(e))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){let t=new Q(new $([])),n=new sf(t,e),r=new sf(t,e+1),i=n4();return this.gr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sf(e,0),n=this.Vr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sf{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return Q.comparator(e.key,t.key)||P(e.Cr,t.Cr)}static pr(e,t){return P(e.Cr,t.Cr)||Q.comparator(e.key,t.key)}}class sm{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new tx(sf.mr)}checkEmpty(e){return ea.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rx(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Mr=this.Mr.add(new sf(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ea.resolve(s)}lookupMutationBatch(e,t){return ea.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.Nr(t+1),r=n<0?0:n;return ea.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ea.resolve(0===this.mutationQueue.length?-1:this.Fr-1)}getAllMutationBatches(e){return ea.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sf(t,0),r=new sf(t,Number.POSITIVE_INFINITY),i=[];return this.Mr.forEachInRange([n,r],e=>{let t=this.Or(e.Cr);i.push(t)}),ea.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tx(P);return t.forEach(e=>{let t=new sf(e,0),r=new sf(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,r],e=>{n=n.add(e.Cr)})}),ea.resolve(this.Br(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;Q.isDocumentKey(i)||(i=i.child(""));let s=new sf(new Q(i),0),a=new tx(P);return this.Mr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Cr)),!0)},s),ea.resolve(this.Br(a))}Br(e){let t=[];return e.forEach(e=>{let n=this.Or(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){0===this.Lr(t.batchId,"removed")||x(),this.mutationQueue.shift();let n=this.Mr;return ea.forEach(t.mutations,r=>{let i=new sf(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Mr=n})}qn(e){}containsKey(e,t){let n=new sf(t,0),r=this.Mr.firstAfterOrEqual(n);return ea.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ea.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){let t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sg{constructor(e){this.kr=e,this.docs=new tE(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.kr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ea.resolve(n?n.document.mutableCopy():no.newInvalidDocument(t))}getEntries(e,t){let n=nJ;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():no.newInvalidDocument(e))}),ea.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=nJ,s=t.path,a=new Q(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=en(ee(a),n)||(r.has(a.key)||nH(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ea.resolve(i)}getAllFromCollectionGroup(e,t,n,r){x()}qr(e,t){return ea.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sp(this)}getSize(e){return ea.resolve(this.size)}}class sp extends st{constructor(e){super(),this.Ir=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Ir.addEntry(e,r)):this.Ir.removeEntry(n)}),ea.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class sy{constructor(e){this.persistence=e,this.Qr=new nZ(e=>nk(e),nA),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.$r=0,this.Kr=new sd,this.targetCount=0,this.Ur=i1.Kn()}forEachTarget(e,t){return this.Qr.forEach((e,n)=>t(n)),ea.resolve()}getLastRemoteSnapshotVersion(e){return ea.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ea.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Ur.next(),ea.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.$r&&(this.$r=t),ea.resolve()}zn(e){this.Qr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Ur=new i1(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,ea.resolve()}updateTargetData(e,t){return this.zn(t),ea.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Kr.Sr(t.targetId),this.targetCount-=1,ea.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.Qr.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Qr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ea.waitFor(i).next(()=>r)}getTargetCount(e){return ea.resolve(this.targetCount)}getTargetData(e,t){let n=this.Qr.get(t)||null;return ea.resolve(n)}addMatchingKeys(e,t,n){return this.Kr.yr(t,n),ea.resolve()}removeMatchingKeys(e,t,n){this.Kr.br(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ea.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Kr.Sr(t),ea.resolve()}getMatchingKeysForTargetId(e,t){let n=this.Kr.vr(t);return ea.resolve(n)}containsKey(e,t){return ea.resolve(this.Kr.containsKey(t))}}class sw{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new eT(0),this.zr=!1,this.zr=!0,this.jr=new sc,this.referenceDelegate=e(this),this.Hr=new sy(this),this.indexManager=new iK,this.remoteDocumentCache=new sg(e=>this.referenceDelegate.Jr(e)),this.serializer=new ih(t),this.Yr=new su(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Wr[e.toKey()];return n||(n=new sm(t,this.referenceDelegate),this.Wr[e.toKey()]=n),n}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,n){T("MemoryPersistence","Starting transaction:",e);let r=new sv(this.Gr.next());return this.referenceDelegate.Zr(),n(r).next(e=>this.referenceDelegate.Xr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}ei(e,t){return ea.or(Object.values(this.Wr).map(n=>()=>n.containsKey(e,t)))}}class sv extends ei{constructor(e){super(),this.currentSequenceNumber=e}}class sI{constructor(e){this.persistence=e,this.ti=new sd,this.ni=null}static ri(e){return new sI(e)}get ii(){if(this.ni)return this.ni;throw x()}addReference(e,t,n){return this.ti.addReference(n,t),this.ii.delete(n.toString()),ea.resolve()}removeReference(e,t,n){return this.ti.removeReference(n,t),this.ii.add(n.toString()),ea.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),ea.resolve()}removeTarget(e,t){this.ti.Sr(t.targetId).forEach(e=>this.ii.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.ii.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Zr(){this.ni=new Set}Xr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ea.forEach(this.ii,n=>{let r=Q.fromPath(n);return this.si(e,r).next(e=>{e||t.removeEntry(r,B.min())})}).next(()=>(this.ni=null,t.apply(e)))}updateLimboDocument(e,t){return this.si(e,t).next(e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())})}Jr(e){return 0}si(e,t){return ea.or([()=>ea.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class sT{constructor(e,t){this.persistence=e,this.oi=new nZ(e=>ex(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new i9(this,t)}static ri(e,t){return new sT(e,t)}Zr(){}Xr(e){return ea.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){let t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}rr(e,t){return ea.forEach(this.oi,(n,r)=>this.ar(e,n,r).next(e=>e?ea.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.qr(e,r=>this.ar(e,r,t).next(e=>{e||(n++,i.removeEntry(r,B.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),ea.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),ea.resolve()}removeReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),ea.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),ea.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(tZ(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tq(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return tM(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tI(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw x()}}(e.data.value)),t}ar(e,t,n){return ea.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.oi.get(t);return ea.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sE{constructor(e){this.serializer=e}B(e,t,n,r){let i=new el("createOrUpgrade",t);n<1&&r>=1&&(!function(e){e.createObjectStore(eD)}(e),e.createObjectStore(ek,{keyPath:"userId"}),e.createObjectStore(eA,{keyPath:eV,autoIncrement:!0}).createIndex(eR,eM,{unique:!0}),e.createObjectStore(eL),s_(e),function(e){e.createObjectStore(eN)}(e));let s=ea.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(eH),e.deleteObjectStore(eG),e.deleteObjectStore(eX),s_(e)),s=s.next(()=>(function(e){let t=e.store(eX),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return t.put(eJ,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eA).G().next(t=>{e.deleteObjectStore(eA),e.createObjectStore(eA,{keyPath:eV,autoIncrement:!0}).createIndex(eR,eM,{unique:!0});let n=i.store(eA),r=t.map(e=>n.put(e));return ea.waitFor(r)}))),s=s.next(()=>{!function(e){e.createObjectStore(e2,{keyPath:"clientId"})}(e)})),n<5&&r>=5&&(s=s.next(()=>this._i(i))),n<6&&r>=6&&(s=s.next(()=>((function(e){e.createObjectStore(ez)})(e),this.ai(i)))),n<7&&r>=7&&(s=s.next(()=>this.ui(i))),n<8&&r>=8&&(s=s.next(()=>this.ci(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.li(i))),n<11&&r>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(e5,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(e8,{keyPath:"name"})}(e)})),n<12&&r>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(ts,{keyPath:ta});t.createIndex(to,tl,{unique:!1}),t.createIndex(tu,th,{unique:!1})}(e)})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eF,{keyPath:eP});t.createIndex(eU,eq),t.createIndex(eB,eK)})(e)).next(()=>this.hi(e,i)).next(()=>e.deleteObjectStore(eN))),n<14&&r>=14&&(s=s.next(()=>this.Pi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(e4,{keyPath:"indexId",autoIncrement:!0}).createIndex(e3,"collectionGroup",{unique:!1}),e.createObjectStore(e6,{keyPath:e9}).createIndex(e7,te,{unique:!1}),e.createObjectStore(tt,{keyPath:tn}).createIndex(tr,ti,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(e6).clear()}).next(()=>{t.objectStore(tt).clear()})),n<17&&r>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tc,{keyPath:"name"})}(e)})),s}ai(e){let t=0;return e.store(eN).Z((e,n)=>{t+=iZ(n)}).next(()=>{let n={byteSize:t};return e.store(ez).put(e$,n)})}_i(e){let t=e.store(ek),n=e.store(eA);return t.G().next(t=>ea.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.G(eR,r).next(n=>ea.forEach(n,n=>{n.userId===t.userId||x();let r=ip(this.serializer,n);return iY(e,t.userId,r).next(()=>{})}))}))}ui(e){let t=e.store(eH),n=e.store(eN);return e.store(eX).get(eJ).next(e=>{let r=[];return n.Z((n,i)=>{let s=new $(n),a=[0,ex(s)];r.push(t.get(a).next(n=>n?ea.resolve():t.put({targetId:0,path:ex(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ea.waitFor(r))})}ci(e,t){e.createObjectStore(e0,{keyPath:e1});let n=t.store(e0),r=new iz,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:ex(r)})}};return t.store(eN).Z({Y:!0},(e,t)=>i(new $(e).popLast())).next(()=>t.store(eL).Z({Y:!0},([e,t,n],r)=>i(eS(t).popLast())))}li(e){let t=e.store(eG);return t.Z((e,n)=>{let r=iy(n),i=iw(this.serializer,r);return t.put(i)})}hi(e,t){let n=t.store(eN),r=[];return n.Z((e,n)=>{let i=t.store(eF),s=(n.document?new Q($.fromString(n.document.name).popFirst(5)):n.noDocument?Q.fromSegments(n.noDocument.path):n.unknownDocument?Q.fromSegments(n.unknownDocument.path):x()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ea.waitFor(r))}Pi(e,t){let n=t.store(eA),r=new sn(this.serializer),i=new sw(sI.ri,this.serializer.Tt);return n.G().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:n4();ip(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),ea.forEach(n,(e,n)=>{let s=new y(n),a=ib.It(this.serializer,s),o=i.getIndexManager(s);return new sl(r,iJ.It(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new ty(t,eT.ae),e).next()})})}}function s_(e){e.createObjectStore(eH,{keyPath:eW}).createIndex(eY,eZ,{unique:!0}),e.createObjectStore(eG,{keyPath:"targetId"}).createIndex(ej,eQ,{unique:!0}),e.createObjectStore(eX)}let sb="IndexedDbPersistence",sx="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sS{constructor(e,t,n,r,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ti=i,this.window=s,this.document=a,this.Ii=l,this.Ei=u,this.di=h,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!sS.D())throw new N(S.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new i7(this,r),this.gi=t+"main",this.serializer=new ih(o),this.pi=new eu(this.gi,this.di,new sE(this.serializer)),this.jr=new ix,this.Hr=new i2(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sn(this.serializer),this.Yr=new i_,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===u&&E(sb,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sx);return this.bi(),this.Si(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Hr.getHighestSequenceNumber(e))}).then(e=>{this.Gr=new eT(e,this.Ii)}).then(()=>{this.zr=!0}).catch(e=>(this.pi&&this.pi.close(),Promise.reject(e)))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget(async()=>{this.started&&await this.wi()}))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tw(e,e2).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Fi(e).next(e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Mi(e)).next(t=>this.isPrimary&&!t?this.xi(e).next(()=>!1):!!t&&this.Oi(e).next(()=>!0))).catch(e=>{if(ef(e))return T(sb,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sb,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Fi(e){return tw(e,eD).get(eC).next(e=>ea.resolve(this.Ni(e)))}Bi(e){return tw(e,e2).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,18e5)){this.mi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tw(e,e2);return t.G().next(e=>{let n=this.qi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ea.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.yi)for(let t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.wi().then(()=>this.Li()).then(()=>this.Di()))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?ea.resolve(!0):tw(e,eD).get(eC).next(t=>{if(null!==t&&this.ki(t.leaseTimestampMs,5e3)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sx);return!1}}return!(!this.networkEnabled||!this.inForeground)||tw(e,e2).G().next(e=>void 0===this.qi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sb,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.zr=!1,this.Ki(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ui(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[eD,e2],e=>{let t=new ty(e,eT.ae);return this.xi(t).next(()=>this.Bi(t))}),this.pi.close(),this.Gi()}qi(e,t){return e.filter(e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId))}zi(){return this.runTransaction("getActiveClients","readonly",e=>tw(e,e2).G().next(e=>this.qi(e,18e5).map(e=>e.clientId)))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return iJ.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new ij(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return ib.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,n){var r;let i;T(sb,"Starting transaction:",e);let s=17===(r=this.di)?tp:16===r?tg:15===r?tg:14===r?tm:13===r?tm:12===r?tf:11===r?td:void x();return this.pi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new ty(r,this.Gr?this.Gr.next():eT.ae),"readwrite-primary"===t?this.Fi(i).next(e=>!!e||this.Mi(i)).next(t=>{if(!t)throw E(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)),new N(S.FAILED_PRECONDITION,er);return n(i)}).next(e=>this.Oi(i).next(()=>e)):this.ji(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}ji(e){return tw(e,eD).get(eC).next(e=>{if(null!==e&&this.ki(e.leaseTimestampMs,5e3)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(S.FAILED_PRECONDITION,sx)})}Oi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tw(e,eD).put(eC,t)}static D(){return eu.D()}xi(e){let t=tw(e,eD);return t.get(eC).next(e=>this.Ni(e)?(T(sb,"Releasing primary lease."),t.delete(eC)):ea.resolve())}ki(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(E(`Detected an update time that is in the future: ${e} > ${n}`),!1))}bi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.wi()))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ui(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}Si(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ki();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{let n=null!==(null===(t=this.yi)||void 0===t?void 0:t.getItem(this.Qi(e)));return T(sb,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return E(sb,"Failed to get zombied client id.",e),!1}}Ki(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){E("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sN(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class sD{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Hi=n,this.Ji=r}static Yi(e,t){let n=n4(),r=n4();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sD(e,t.fromCache,n,r)}}class sC{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sk{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,h.nr)()?8:eh((0,h.ZQ)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.rs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ss(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sC;return this._s(e,t,n).next(r=>{if(i.result=r,this.Xi)return this.us(e,t,n,r.size)})}).next(()=>i.result)}us(e,t,n,r){return n.documentReadCount<this.es?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",nQ(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),ea.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",nQ(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ts*r?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",nQ(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nB(t))):ea.resolve())}rs(e,t){if(nP(t))return ea.resolve(null);let n=nB(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=nB(t=n$(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=n4(...r);return this.ns.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.cs(t,r);return this.ls(t,s,i,n.readTime)?this.rs(e,n$(t,null,"F")):this.hs(e,s,t,n)}))})))}ss(e,t,n,r){return nP(t)||r.isEqual(B.min())?ea.resolve(null):this.ns.getDocuments(e,n).next(i=>{let s=this.cs(t,i);return this.ls(t,s,n,r)?ea.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),nQ(t)),this.hs(e,s,t,X(r,-1)).next(e=>e))})}cs(e,t){let n=new tx(nY(e));return t.forEach((t,r)=>{nH(e,r)&&(n=n.add(r))}),n}ls(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}_s(e,t,n){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",nQ(t)),this.ns.getDocumentsMatchingQuery(e,t,et.min(),n)}hs(e,t,n,r){return this.ns.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sA="LocalStore";class sV{constructor(e,t,n,r){this.persistence=e,this.Ps=t,this.serializer=r,this.Ts=new tE(P),this.Is=new nZ(e=>nk(e),nA),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(n)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sl(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ts))}}async function sR(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.As(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=n4();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Rs:e,removedBatchIds:i,addedBatchIds:s}))})})}function sM(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Hr.getLastRemoteSnapshotVersion(t))}function sO(e,t,n){let r=n4(),i=n4();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=nJ;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(B.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):T(sA,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Vs:r,fs:i}})}function sL(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Hr.getTargetData(n,t).next(i=>i?(r=i,ea.resolve(r)):e.Hr.allocateTargetId(n).next(i=>(r=new iu(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Hr.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.Ts.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.Ts=e.Ts.insert(n.targetId,n),e.Is.set(t,n.targetId)),n})}async function sF(e,t,n){let r=e.Ts.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!ef(e))throw e;T(sA,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ts=e.Ts.remove(t),e.Is.delete(r.target)}function sP(e,t,n){let r=B.min(),i=n4();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.Is.get(n);return void 0!==r?ea.resolve(e.Ts.get(r)):e.Hr.getTargetData(t,n)})(e,s,nB(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Hr.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ps.getDocumentsMatchingQuery(s,t,n?r:B.min(),n?i:n4())).next(n=>(sB(e,nW(t),n),{documents:n,gs:i})))}function sU(e,t){let n=e.Hr,r=e.Ts.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.lt(e,t).next(e=>e?e.target:null))}function sq(e,t){let n=e.Es.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.ds.getAllFromCollectionGroup(r,t,X(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(sB(e,t,n),n))}function sB(e,t,n){let r=e.Es.get(t)||B.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Es.set(t,r)}async function sK(e,t,n,r){let i=n4(),s=nJ;for(let e of n){let n=t.ps(e.metadata.name);e.document&&(i=i.add(n));let r=t.ys(e);r.setReadTime(t.ws(e.metadata.readTime)),s=s.insert(n,r)}let a=e.ds.newChangeBuffer({trackRemovals:!0}),o=await sL(e,nB(nF($.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sO(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Hr.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Hr.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.Vs,n.fs)).next(()=>n.Vs)))}async function sz(e,t,n=n4()){let r=await sL(e,nB(iv(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=rJ(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Yr.saveNamedQuery(i,t);let a=r.withResumeToken(tk.EMPTY_BYTE_STRING,s);return e.Ts=e.Ts.insert(a.targetId,a),e.Hr.updateTargetData(i,a).next(()=>e.Hr.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Hr.addMatchingKeys(i,n,r.targetId)).next(()=>e.Yr.saveNamedQuery(i,t))})}let s$="firestore_clients";function sG(e,t){return`${s$}_${e}_${t}`}let sj="firestore_mutations";function sQ(e,t,n){let r=`${sj}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let sH="firestore_targets";function sW(e,t){return`${sH}_${e}_${t}`}let sY="SharedClientState";class sZ{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static bs(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new N(r.error.code,r.error.message)),s?new sZ(e,t,r.state,i):(E(sY,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Ss(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sJ{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static bs(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new N(n.error.code,n.error.message)),i?new sJ(e,n.state,r):(E(sY,`Failed to parse target state for ID '${e}': ${t}`),null)}Ss(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sX{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static bs(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=n3;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eb(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new sX(e,i):(E(sY,`Failed to parse client data for instance '${e}': ${t}`),null)}}class s0{constructor(e,t){this.clientId=e,this.onlineState=t}static bs(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new s0(t.clientId,t.onlineState):(E(sY,`Failed to parse online state: ${e}`),null)}}class s1{constructor(){this.activeTargetIds=n3}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Ss(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class s2{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Ti=t,this.persistenceKey=n,this.Cs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new tE(P),this.started=!1,this.Os=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ns=sG(this.persistenceKey,this.Cs),this.Bs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.xs=this.xs.insert(this.Cs,new s1),this.Ls=RegExp(`^${s$}_${l}_([^_]*)$`),this.ks=RegExp(`^${sj}_${l}_(\\d+)(?:_(.*))?$`),this.qs=RegExp(`^${sH}_${l}_(\\d+)$`),this.Qs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.$s=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.zi())){if(e===this.Cs)continue;let t=this.getItem(sG(this.persistenceKey,e));if(t){let n=sX.bs(e,t);n&&(this.xs=this.xs.insert(n.clientId,n))}}this.Ks();let e=this.storage.getItem(this.Qs);if(e){let t=this.Us(e);t&&this.Ws(t)}for(let e of this.Os)this.Ms(e);this.Os=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,n){this.zs(e,t,n),this.js(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sW(this.persistenceKey,e));if(t){let r=sJ.bs(e,t);r&&(n=r.state)}}return t&&this.Hs.Ds(e),this.Ks(),n}removeLocalQueryTarget(e){this.Hs.vs(e),this.Ks()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sW(this.persistenceKey,e))}updateQueryState(e,t,n){this.Js(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.js(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(sY,"READ",e,t),t}setItem(e,t){T(sY,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(sY,"REMOVE",e),this.storage.removeItem(e)}Ms(e){if(e.storageArea===this.storage){if(T(sY,"EVENT",e.key,e.newValue),e.key===this.Ns)return void E("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Ls.test(e.key)){if(null==e.newValue){let t=this.Xs(e.key);return this.eo(t,null)}{let t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){let t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){let t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){let t=this.Us(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){let t=function(e){let t=eT.ae;if(null!=e)try{let n=JSON.parse(e);"number"==typeof n||x(),t=n}catch(e){E(sY,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eT.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){let t=this._o(e.newValue);await Promise.all(t.map(e=>this.syncEngine.ao(e)))}}}else this.Os.push(e)})}}get Hs(){return this.xs.get(this.Cs)}Ks(){this.setItem(this.Ns,this.Hs.Ss())}zs(e,t,n){let r=new sZ(this.currentUser,e,t,n),i=sQ(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Ss())}js(e){let t=sQ(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){let t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,n){let r=sW(this.persistenceKey,e),i=new sJ(e,t,n);this.setItem(r,i.Ss())}Zs(e){let t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){let t=this.Ls.exec(e);return t?t[1]:null}no(e,t){let n=this.Xs(e);return sX.bs(n,t)}ro(e,t){let n=this.ks.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return sZ.bs(new y(i),r,t)}so(e,t){let n=Number(this.qs.exec(e)[1]);return sJ.bs(n,t)}Us(e){return s0.bs(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);T(sY,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){let n=t?this.xs.insert(e,t):this.xs.remove(e),r=this.Gs(this.xs),i=this.Gs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.lo(s,a).then(()=>{this.xs=n})}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=n3;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class s5{constructor(){this.ho=new s1,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,n){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new s1,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class s8{To(e){}shutdown(){}}let s4="ConnectivityMonitor";class s3{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){for(let e of(T(s4,"Network connectivity changed: AVAILABLE"),this.Vo))e(0)}Ro(){for(let e of(T(s4,"Network connectivity changed: UNAVAILABLE"),this.Vo))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let s6=null;function s9(){return null===s6?s6=0x10000000+Math.round(0x80000000*Math.random()):s6++,"0x"+s6.toString(16)}let s7="RestConnection",ae={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class at{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/${r}`,this.wo=this.databaseId.database===tz?`project_id=${n}`:`project_id=${n}&database_id=${r}`}bo(e,t,n,r,i){let s=s9(),a=this.So(e,t.toUriEncodedString());T(s7,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(o,r,i),this.vo(e,a,o,n).then(t=>(T(s7,`Received RPC '${e}' ${s}: `,t),t),t=>{throw _(s7,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Co(e,t,n,r,i,s){return this.bo(e,t,n,r,i)}Do(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}So(e,t){let n=ae[e];return`${this.po}/v1/${t}:${n}`}terminate(){}}class an{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Ko(e){this.ko(e)}Uo(e){this.qo(e)}}let ar="WebChannelConnection";class ai extends at{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,n,r){let i=s9();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(ar,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:T(ar,`RPC '${e}' ${i} timed out`),a(new N(S.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(T(ar,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(t)>=0?t:S.UNKNOWN}(t.status);a(new N(e,t.message))}else a(new N(S.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new N(S.UNAVAILABLE,"Connection failed."));break;default:x()}}finally{T(ar,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(r);T(ar,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",l,n,15)})}Wo(e,t,n){let i=s9(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Do(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let h=s.join("");T(ar,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new an({Fo:t=>{m?T(ar,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(ar,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(ar,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Mo:()=>c.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(ar,`RPC '${e}' stream ${i} transport opened.`),g.Qo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(ar,`RPC '${e}' stream ${i} transport closed`),g.Ko())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,_(ar,`RPC '${e}' stream ${i} transport errored:`,t),g.Ko(new N(S.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var n;if(!m){let s=t.data[0];s||x();let a=(null==s?void 0:s.error)||(null===(n=s[0])||void 0===n?void 0:n.error);if(a){T(ar,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return rk(t)}(t),s=a.message;void 0===n&&(n=S.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.Ko(new N(n,s)),c.close()}else T(ar,`RPC '${e}' stream ${i} received:`,s),g.Uo(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(ar,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(ar,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.$o()},0),g}}function as(){return"undefined"!=typeof window?window:null}function aa(){return"undefined"!=typeof document?document:null}function ao(e){return new rH(e,!0)}class al{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Ti=e,this.timerId=t,this.Go=n,this.zo=r,this.jo=i,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();let t=Math.floor(this.Ho+this.e_()),n=Math.max(0,Date.now()-this.Yo),r=Math.max(0,t-n);r>0&&T("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,r,()=>(this.Yo=Date.now(),e())),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}let au="PersistentStream";class ah{constructor(e,t,n,r,i,s,a,o){this.Ti=e,this.n_=n,this.r_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new al(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,()=>this.T_()))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(E(t.toString()),E("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===S.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;let e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.i_===t&&this.V_(e,n)},t=>{e(()=>{let e=new N(S.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)})})}V_(e,t){let n=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo(()=>{n(()=>this.listener.xo())}),this.stream.No(()=>{n(()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,()=>(this.c_()&&(this.state=3),Promise.resolve())),this.listener.No()))}),this.stream.Lo(e=>{n(()=>this.m_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.__?this.g_(e):this.onNext(e))})}l_(){this.state=5,this.a_.Xo(async()=>{this.state=0,this.start()})}m_(e){return T(au,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget(()=>this.i_===e?t():(T(au,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class ac extends ah{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:x(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||x(),tk.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||x(),tk.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new rq(s,a,o,l&&new N(void 0===l.code?S.UNKNOWN:rk(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=r5(e,r.document.name),s=rJ(r.document.updateTime),a=r.document.createTime?rJ(r.document.createTime):B.min(),o=new na({mapValue:{fields:r.document.fields}}),l=no.newFoundDocument(i,s,a,o);n=new rP(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=r5(e,r.document),s=r.readTime?rJ(r.readTime):B.min(),a=no.newNoDocument(i,s);n=new rP([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=r5(e,r.document);n=new rP([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x();{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rD(r,i);n=new rU(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return B.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?rJ(t.readTime):B.min()}(e);return this.listener.p_(t,n)}y_(e){let t={};t.database=r3(this.serializer),t.addTarget=function(e,t){let n;let r=t.target;if((n=nV(r)?{documents:ir(e,r)}:{query:ii(e,r).ht}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=rZ(e,t.resumeToken);let r=rW(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(B.min())>0){n.readTime=rY(e,t.snapshotVersion.toTimestamp());let r=rW(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.I_(t)}w_(e){let t={};t.database=r3(this.serializer),t.removeTarget=e,this.I_(t)}}class ad extends ah{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get b_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.b_&&this.S_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return e.streamToken||x(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&x(),this.listener.D_()}onNext(e){var t,n;e.streamToken||x(),this.lastStreamToken=e.streamToken,this.a_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(void 0!==n||x(),t.map(e=>{let t;return(t=e.updateTime?rJ(e.updateTime):rJ(n)).isEqual(B.min())&&(t=rJ(n)),new rc(t,e.transformResults||[])})):[]),i=rJ(e.commitTime);return this.listener.v_(i,r)}C_(){let e={};e.database=r3(this.serializer),this.I_(e)}S_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ie(this.serializer,e))};this.I_(t)}}class af{}class am extends af{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.F_=!1}M_(){if(this.F_)throw new N(S.FAILED_PRECONDITION,"The client has already been terminated.")}bo(e,t,n,r){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.bo(e,r0(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}Co(e,t,n,r,i){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(e,r0(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}terminate(){this.F_=!0,this.connection.terminate()}}class ag{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve())))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(E(t),this.N_=!1):T("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}let ap="RemoteStore";class ay{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.K_=[],this.U_=new Map,this.W_=new Set,this.G_=[],this.z_=i,this.z_.To(e=>{n.enqueueAndForget(async()=>{aS(this)&&(T(ap,"Restarting streams for network reachability change."),await async function(e){e.W_.add(4),await av(e),e.j_.set("Unknown"),e.W_.delete(4),await aw(e)}(this))})}),this.j_=new ag(n,r)}}async function aw(e){if(aS(e))for(let t of e.G_)await t(!0)}async function av(e){for(let t of e.G_)await t(!1)}function aI(e,t){e.U_.has(t.targetId)||(e.U_.set(t.targetId,t),ax(e)?ab(e):aK(e).c_()&&aE(e,t))}function aT(e,t){let n=aK(e);e.U_.delete(t),n.c_()&&a_(e,t),0===e.U_.size&&(n.c_()?n.P_():aS(e)&&e.j_.set("Unknown"))}function aE(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}aK(e).y_(t)}function a_(e,t){e.H_.Ne(t),aK(e).w_(t)}function ab(e){e.H_=new rK({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.U_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),aK(e).start(),e.j_.B_()}function ax(e){return aS(e)&&!aK(e).u_()&&e.U_.size>0}function aS(e){return 0===e.W_.size}async function aN(e){e.j_.set("Online")}async function aD(e){e.U_.forEach((t,n)=>{aE(e,t)})}async function aC(e,t){e.H_=void 0,ax(e)?(e.j_.q_(t),ab(e)):e.j_.set("Unknown")}async function ak(e,t,n){if(e.j_.set("Online"),t instanceof rq&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.U_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.U_.delete(r),e.H_.removeTarget(r))}(e,t)}catch(n){T(ap,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await aA(e,n)}else if(t instanceof rP?e.H_.We(t):t instanceof rU?e.H_.Ze(t):e.H_.je(t),!n.isEqual(B.min()))try{let t=await sM(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.H_.ot(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.U_.get(r);i&&e.U_.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.U_.get(t);if(!r)return;e.U_.set(t,r.withResumeToken(tk.EMPTY_BYTE_STRING,r.snapshotVersion)),a_(e,t);let i=new iu(r.target,t,n,r.sequenceNumber);aE(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){T(ap,"Failed to raise snapshot:",t),await aA(e,t)}}async function aA(e,t,n){if(!ef(t))throw t;e.W_.add(1),await av(e),e.j_.set("Offline"),n||(n=()=>sM(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(ap,"Retrying IndexedDB access"),await n(),e.W_.delete(1),await aw(e)})}function aV(e,t){return t().catch(n=>aA(e,n,t))}async function aR(e){var t;let n=az(e),r=e.K_.length>0?e.K_[e.K_.length-1].batchId:-1;for(;aS(t=e)&&t.K_.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.K_.length&&n.P_();break}r=t.batchId,function(e,t){e.K_.push(t);let n=az(e);n.c_()&&n.b_&&n.S_(t.mutations)}(e,t)}catch(t){await aA(e,t)}aM(e)&&aO(e)}function aM(e){return aS(e)&&!az(e).u_()&&e.K_.length>0}function aO(e){az(e).start()}async function aL(e){az(e).C_()}async function aF(e){let t=az(e);for(let n of e.K_)t.S_(n.mutations)}async function aP(e,t,n){let r=e.K_.shift(),i=rS.from(r,t,n);await aV(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aR(e)}async function aU(e,t){t&&az(e).b_&&await async function(e,t){var n;if(rC(n=t.code)&&n!==S.ABORTED){let n=e.K_.shift();az(e).h_(),await aV(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await aR(e)}}(e,t),aM(e)&&aO(e)}async function aq(e,t){e.asyncQueue.verifyOperationInProgress(),T(ap,"RemoteStore received new credentials");let n=aS(e);e.W_.add(3),await av(e),n&&e.j_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.W_.delete(3),await aw(e)}async function aB(e,t){t?(e.W_.delete(2),await aw(e)):t||(e.W_.add(2),await av(e),e.j_.set("Unknown"))}function aK(e){var t,n,r;return e.J_||(e.J_=(t=e.datastore,n=e.asyncQueue,r={xo:aN.bind(null,e),No:aD.bind(null,e),Lo:aC.bind(null,e),p_:ak.bind(null,e)},t.M_(),new ac(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.G_.push(async t=>{t?(e.J_.h_(),ax(e)?ab(e):e.j_.set("Unknown")):(await e.J_.stop(),e.H_=void 0)})),e.J_}function az(e){var t,n,r;return e.Y_||(e.Y_=(t=e.datastore,n=e.asyncQueue,r={xo:()=>Promise.resolve(),No:aL.bind(null,e),Lo:aU.bind(null,e),D_:aF.bind(null,e),v_:aP.bind(null,e)},t.M_(),new ad(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.G_.push(async t=>{t?(e.Y_.h_(),await aR(e)):(await e.Y_.stop(),e.K_.length>0&&(T(ap,`Stopping write stream with ${e.K_.length} pending writes`),e.K_=[]))})),e.Y_}class a${constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new D,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new a$(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function aG(e,t){if(E("AsyncQueue",`${t}: ${e}`),ef(e))return new N(S.UNAVAILABLE,`${t}: ${e}`);throw e}class aj{static emptySet(e){return new aj(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||Q.comparator(t.key,n.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=n0(),this.sortedSet=new tE(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof aj)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new aj;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class aQ{constructor(){this.Z_=new tE(Q.comparator)}track(e){let t=e.doc.key,n=this.Z_.get(t);n?0!==e.type&&3===n.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==n.type?this.Z_=this.Z_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Z_=this.Z_.remove(t):1===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):x():this.Z_=this.Z_.insert(t,e)}X_(){let e=[];return this.Z_.inorderTraversal((t,n)=>{e.push(n)}),e}}class aH{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new aH(e,t,aj.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&nG(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class aW{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some(e=>e.ra())}}class aY{constructor(){this.queries=aZ(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=aZ(),n.forEach((e,n)=>{for(let e of n.ta)e.onError(t)})}(this,new N(S.ABORTED,"Firestore shutting down"))}}function aZ(){return new nZ(e=>nj(e),nG)}async function aJ(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.na()&&t.ra()&&(n=2):(i=new aW,n=+!t.ra());try{switch(n){case 0:i.ea=await e.onListen(r,!0);break;case 1:i.ea=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=aG(n,`Initialization of query '${nQ(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.ta.push(t),t.sa(e.onlineState),i.ea&&t.oa(i.ea)&&a2(e)}async function aX(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.ta.indexOf(t);e>=0&&(i.ta.splice(e,1),0===i.ta.length?r=+!t.ra():!i.na()&&t.ra()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function a0(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.ta)e.oa(r)&&(n=!0);i.ea=r}}n&&a2(e)}function a1(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.ta)e.onError(n);e.queries.delete(t)}function a2(e){e.ia.forEach(e=>{e.next()})}(a=s||(s={}))._a="default",a.Cache="cache";class a5{constructor(e,t,n){this.query=e,this.aa=t,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=n||{}}oa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new aH(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ua?this.la(e)&&(this.aa.next(e),t=!0):this.ha(e,this.onlineState)&&(this.Pa(e),t=!0),this.ca=e,t}onError(e){this.aa.error(e)}sa(e){this.onlineState=e;let t=!1;return this.ca&&!this.ua&&this.ha(this.ca,e)&&(this.Pa(this.ca),t=!0),t}ha(e,t){return!(e.fromCache&&this.ra())||(!this.options.Ta||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}la(e){if(e.docChanges.length>0)return!0;let t=this.ca&&this.ca.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Pa(e){e=aH.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ua=!0,this.aa.next(e)}ra(){return this.options.source!==s.Cache}}class a8{constructor(e,t){this.Ia=e,this.byteLength=t}Ea(){return"metadata"in this.Ia}}class a4{constructor(e){this.serializer=e}ps(e){return r5(this.serializer,e)}ys(e){return e.metadata.exists?r7(this.serializer,e.document,!1):no.newNoDocument(this.ps(e.metadata.name),this.ws(e.metadata.readTime))}ws(e){return rJ(e)}}class a3{constructor(e){this.key=e}}class a6{constructor(e){this.key=e}}class a9{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=n4(),this.mutatedKeys=n4(),this.ya=nY(e),this.wa=new aj(this.ya)}get ba(){return this.fa}Sa(e,t){let n=t?t.Da:new aQ,r=t?t.wa:this.wa,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=nH(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.va(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.ya(h,o)>0||l&&0>this.ya(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{wa:s,Da:n,ls:a,mutatedKeys:i}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;let s=e.Da.X_();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x()}};return n(e)-n(t)})(e.type,t.type)||this.ya(e.doc,t.doc)),this.Ca(n),r=null!=r&&r;let a=t&&!r?this.Fa():[],o=0===this.pa.size&&this.current&&!r?1:0,l=o!==this.ga;return(this.ga=o,0!==s.length||l)?{snapshot:new aH(this.query,e.wa,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),Ma:a}:{Ma:a}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new aQ,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach(e=>this.fa=this.fa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.fa=this.fa.delete(e)),this.current=e.current)}Fa(){if(!this.current)return[];let e=this.pa;this.pa=n4(),this.wa.forEach(e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))});let t=[];return e.forEach(e=>{this.pa.has(e)||t.push(new a6(e))}),this.pa.forEach(n=>{e.has(n)||t.push(new a3(n))}),t}Oa(e){this.fa=e.gs,this.pa=n4();let t=this.Sa(e.documents);return this.applyChanges(t,!0)}Na(){return aH.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}let a7="SyncEngine";class oe{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class ot{constructor(e){this.key=e,this.Ba=!1}}class on{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.La={},this.ka=new nZ(e=>nj(e),nG),this.qa=new Map,this.Qa=new Set,this.$a=new tE(Q.comparator),this.Ka=new Map,this.Ua=new sd,this.Wa={},this.Ga=new Map,this.za=i1.Un(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function or(e,t,n=!0){let r;let i=oR(e),s=i.ka.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.Na()):r=await os(i,t,n,!0),r}async function oi(e,t){let n=oR(e);await os(n,t,!0,!1)}async function os(e,t,n,r){let i;let s=await sL(e.localStore,nB(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await oa(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aI(e.remoteStore,s),i}async function oa(e,t,n,r,i){e.Ha=(t,n,r)=>(async function(e,t,n,r){let i=t.view.Sa(n);i.ls&&(i=await sP(e.localStore,t.query,!1).then(({documents:e})=>t.view.Sa(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return ov(e,t.targetId,o.Ma),o.snapshot})(e,t,n,r);let s=await sP(e.localStore,t,!0),a=new a9(t,s.gs),o=a.Sa(s.documents),l=rF.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);ov(e,n,u.Ma);let h=new oe(t,n,a);return e.ka.set(t,h),e.qa.has(n)?e.qa.get(n).push(t):e.qa.set(n,[t]),u.snapshot}async function oo(e,t,n){let r=e.ka.get(t),i=e.qa.get(r.targetId);if(i.length>1)return e.qa.set(r.targetId,i.filter(e=>!nG(e,t))),void e.ka.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sF(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aT(e.remoteStore,r.targetId),oy(e,r.targetId)}).catch(es)):(oy(e,r.targetId),await sF(e.localStore,r.targetId,!0))}async function ol(e,t){let n=e.ka.get(t),r=e.qa.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aT(e.remoteStore,n.targetId))}async function ou(e,t,n){let r=oM(e);try{var i;let e;let s=await function(e,t){let n,r;let i=q.now(),s=t.reduce((e,t)=>e.add(t.key),n4());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=nJ,l=n4();return e.ds.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rt(r.transform,e||null);null!=i&&(null===n&&(n=na.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rv(e.key,t,function e(t){let n=[];return tI(t.fields,(t,r)=>{let i=new j([t]);if(t7(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tD(n)}(t.value.mapValue),rd.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:n1(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Wa[r.currentUser.toKey()])||(e=new tE(P)),e=e.insert(i,n),r.Wa[r.currentUser.toKey()]=e,await oT(r,s.changes),await aR(r.remoteStore)}catch(t){let e=aG(t,"Failed to persist write");n.reject(e)}}async function oh(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.Ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.ds.newChangeBuffer({trackRemovals:!0});r=e.Ts;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Hr.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Hr.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tk.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Hr.updateTargetData(i,h))});let o=nJ,l=n4();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sO(i,s,t.documentUpdates).next(e=>{o=e.Vs,l=e.fs})),!n.isEqual(B.min())){let t=e.Hr.getLastRemoteSnapshotVersion(i).next(t=>e.Hr.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ea.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ts=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Ka.get(n);r&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||x(),t.addedDocuments.size>0?r.Ba=!0:t.modifiedDocuments.size>0?r.Ba||x():t.removedDocuments.size>0&&(r.Ba||x(),r.Ba=!1))}),await oT(e,n,t)}catch(e){await es(e)}}function oc(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n;let i=[];e.ka.forEach((e,n)=>{let r=n.view.sa(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.ta)e.sa(t)&&(n=!0)}),n&&a2(r),i.length&&e.La.p_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function od(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Ka.get(t),i=r&&r.key;if(i){let n=new tE(Q.comparator);n=n.insert(i,no.newNoDocument(i,B.min()));let r=n4().add(i),s=new rL(B.min(),new Map,new tE(P),n,r);await oh(e,s),e.$a=e.$a.remove(i),e.Ka.delete(t),oI(e)}else await sF(e.localStore,t,!1).then(()=>oy(e,t,n)).catch(es)}async function of(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.ds.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ea.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);null!==s||x(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=n4();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))});op(e,r,null),og(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oT(e,i)}catch(e){await es(e)}}async function om(e,t,n){var r;try{let i=await (r=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||x(),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))});op(e,t,n),og(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oT(e,i)}catch(e){await es(e)}}function og(e,t){(e.Ga.get(t)||[]).forEach(e=>{e.resolve()}),e.Ga.delete(t)}function op(e,t,n){let r=e.Wa[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Wa[e.currentUser.toKey()]=r}}function oy(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.qa.get(t)))e.ka.delete(r),n&&e.La.Ja(r,n);e.qa.delete(t),e.isPrimaryClient&&e.Ua.Sr(t).forEach(t=>{e.Ua.containsKey(t)||ow(e,t)})}function ow(e,t){e.Qa.delete(t.path.canonicalString());let n=e.$a.get(t);null!==n&&(aT(e.remoteStore,n),e.$a=e.$a.remove(t),e.Ka.delete(n),oI(e))}function ov(e,t,n){for(let r of n)r instanceof a3?(e.Ua.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.$a.get(n)||e.Qa.has(r)||(T(a7,"New document in limbo: "+n),e.Qa.add(r),oI(e))}(e,r)):r instanceof a6?(T(a7,"Document no longer in limbo: "+r.key),e.Ua.removeReference(r.key,t),e.Ua.containsKey(r.key)||ow(e,r.key)):x()}function oI(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){let t=e.Qa.values().next().value;e.Qa.delete(t);let n=new Q($.fromString(t)),r=e.za.next();e.Ka.set(r,new ot(n)),e.$a=e.$a.insert(n,r),aI(e.remoteStore,new iu(nB(nF(n.path)),r,"TargetPurposeLimboResolution",eT.ae))}}async function oT(e,t,n){let r=[],i=[],s=[];e.ka.isEmpty()||(e.ka.forEach((a,o)=>{s.push(e.Ha(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null===(s=null==n?void 0:n.targetChanges.get(o.targetId))||void 0===s?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sD.Yi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.La.p_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ea.forEach(t,t=>ea.forEach(t.Hi,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ea.forEach(t.Ji,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!ef(e))throw e;T(sA,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.Ts.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.Ts=e.Ts.insert(t,i)}}}(e.localStore,i))}async function oE(e,t){var n;if(!e.currentUser.isEqual(t)){T(a7,"User change. New user:",t.toKey());let r=await sR(e.localStore,t);e.currentUser=t,n="'waitForPendingWrites' promise is rejected due to a user change.",e.Ga.forEach(e=>{e.forEach(e=>{e.reject(new N(S.CANCELLED,n))})}),e.Ga.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await oT(e,r.Rs)}}function o_(e,t){let n=e.Ka.get(t);if(n&&n.Ba)return n4().add(n.key);{let n=n4(),r=e.qa.get(t);if(!r)return n;for(let t of r){let r=e.ka.get(t);n=n.unionWith(r.view.ba)}return n}}async function ob(e,t){let n=await sP(e.localStore,t.query,!0),r=t.view.Oa(n);return e.isPrimaryClient&&ov(e,t.targetId,r.Ma),r}async function ox(e,t){return sq(e.localStore,t).then(t=>oT(e,t))}async function oS(e,t,n,r){let i=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.Ln(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):ea.resolve(null)))}(e.localStore,t);null!==i?("pending"===n?await aR(e.remoteStore):"acknowledged"===n||"rejected"===n?(op(e,t,r||null),og(e,t),function(e,t){e.mutationQueue.qn(t)}(e.localStore,t)):x(),await oT(e,i)):T(a7,"Cannot apply mutation batch with id: "+t)}async function oN(e,t){if(oR(e),oM(e),!0===t&&!0!==e.ja){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await oD(e,t.toArray());for(let t of(e.ja=!0,await aB(e.remoteStore,!0),n))aI(e.remoteStore,t)}else if(!1===t&&!1!==e.ja){let t=[],n=Promise.resolve();e.qa.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(oy(e,i),sF(e.localStore,i,!0))),aT(e.remoteStore,i)}),await n,await oD(e,t),e.Ka.forEach((t,n)=>{aT(e.remoteStore,n)}),e.Ua.Dr(),e.Ka=new Map,e.$a=new tE(Q.comparator),e.ja=!1,await aB(e.remoteStore,!1)}}async function oD(e,t,n){let r=[],i=[];for(let n of t){let t;let s=e.qa.get(n);if(s&&0!==s.length)for(let n of(t=await sL(e.localStore,nB(s[0])),s)){let t=e.ka.get(n),r=await ob(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sU(e.localStore,n);t=await sL(e.localStore,r),await oa(e,oC(r),n,!1,t.resumeToken)}r.push(t)}return e.La.p_(i),r}function oC(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new nL(t,n,r,i,s,"F",e.startAt,e.endAt)}function ok(e){return e.localStore.persistence.zi()}async function oA(e,t,n,r){if(e.ja)return void T(a7,"Ignoring unexpected query state notification.");let i=e.qa.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await sq(e.localStore,nW(i[0])),s=rL.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tk.EMPTY_BYTE_STRING);await oT(e,r,s);break}case"rejected":await sF(e.localStore,t,!0),oy(e,t,r);break;default:x()}}async function oV(e,t,n){let r=oR(e);if(r.ja){for(let e of t){if(r.qa.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){T(a7,"Adding an already active target "+e);continue}let t=await sU(r.localStore,e),n=await sL(r.localStore,t);await oa(r,oC(t),n.targetId,!1,n.resumeToken),aI(r.remoteStore,n)}for(let e of n)r.qa.has(e)&&await sF(r.localStore,e,!1).then(()=>{aT(r.remoteStore,e),oy(r,e)}).catch(es)}}function oR(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oh.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=o_.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=od.bind(null,e),e.La.p_=a0.bind(null,e.eventManager),e.La.Ja=a1.bind(null,e.eventManager),e}function oM(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=of.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=om.bind(null,e),e}class oO{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=ao(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){var t,n;return t=this.persistence,n=new sk,new sV(t,n,e.initialUser,this.serializer)}Xa(e){return new sw(sI.ri,this.serializer)}Za(e){return new s5}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oO.provider={build:()=>new oO};class oL extends oO{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){return this.persistence.referenceDelegate instanceof sT||x(),new i6(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Xa(e){let t=void 0!==this.cacheSizeBytes?iW.withCacheSize(this.cacheSizeBytes):iW.DEFAULT;return new sw(e=>sT.ri(e,t),this.serializer)}}class oF extends oO{constructor(e,t,n){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await oM(this.ru.syncEngine),await aR(this.ru.remoteStore),await this.persistence.Ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}eu(e){var t,n;return t=this.persistence,n=new sk,new sV(t,n,e.initialUser,this.serializer)}tu(e,t){return new i6(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}nu(e,t){let n=new eI(t,this.persistence);return new ev(e.asyncQueue,n)}Xa(e){let t=sN(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?iW.withCacheSize(this.cacheSizeBytes):iW.DEFAULT;return new sS(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,as(),aa(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new s5}}class oP extends oF{constructor(e,t){super(e,t,!1),this.ru=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.ru.syncEngine;this.sharedClientState instanceof s2&&(this.sharedClientState.syncEngine={uo:oS.bind(null,t),co:oA.bind(null,t),lo:oV.bind(null,t),zi:ok.bind(null,t),ao:ox.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ci(async e=>{await oN(this.ru.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Za(e){let t=as();if(!s2.D(t))throw new N(S.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=sN(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new s2(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class oU{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oE.bind(null,this.syncEngine),await aB(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new aY}createDatastore(e){var t;let n=ao(e.databaseInfo.databaseId),r=new ai(e.databaseInfo);return t=e.authCredentials,new am(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new ay(t,n,e.asyncQueue,e=>oc(this.syncEngine,e,0),s3.D()?new s3:new s8)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new on(e,t,n,r,i,s);return a&&(o.ja=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){T(ap,"RemoteStore shutting down."),e.W_.add(5),await av(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}oU.provider={build:()=>new oU};class oq{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.iu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.iu(this.observer.error,e):E("Uncaught Error in snapshot listener:",e.toString()))}su(){this.muted=!0}iu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class oB{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new N(S.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>r2(e.serializer,t))},r=await e.Co("BatchGetDocuments",e.serializer.databaseId,$.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){t.found||x(),t.found.name,t.found.updateTime;let n=r5(e,t.found.name),r=rJ(t.found.updateTime),i=t.found.createTime?rJ(t.found.createTime):B.min(),s=new na({mapValue:{fields:t.found.fields}});return no.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){t.missing||x(),t.readTime||x();let n=r5(e,t.missing),r=rJ(t.readTime);return no.newNoDocument(n,r)}(n,t):x());i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());t||x(),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new r_(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=Q.fromPath(t);this.mutations.push(new rb(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>ie(e.serializer,t))};await e.bo("Commit",e.serializer.databaseId,$.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw x();t=B.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new N(S.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(B.min())?rd.exists(!1):rd.updateTime(t):rd.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new N(S.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return rd.updateTime(t)}return rd.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}let oK="FirestoreClient";class oz{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=F.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{T(oK,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(T(oK,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new D;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=aG(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function o$(e,t){e.asyncQueue.verifyOperationInProgress(),T(oK,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sR(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function oG(e,t){e.asyncQueue.verifyOperationInProgress();let n=await oj(e);T(oK,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>aq(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>aq(t.remoteStore,n)),e._onlineComponents=t}async function oj(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){T(oK,"Using user provided OfflineComponentProvider");try{await o$(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===S.FAILED_PRECONDITION||t.code===S.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;_("Error using user provided cache. Falling back to memory cache: "+t),await o$(e,new oO)}}else T(oK,"Using default OfflineComponentProvider"),await o$(e,new oL(void 0))}return e._offlineComponents}async function oQ(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(oK,"Using user provided OnlineComponentProvider"),await oG(e,e._uninitializedComponentsProvider._online)):(T(oK,"Using default OnlineComponentProvider"),await oG(e,new oU))),e._onlineComponents}async function oH(e){let t=await oQ(e),n=t.eventManager;return n.onListen=or.bind(null,t.syncEngine),n.onUnlisten=oo.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=oi.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=ol.bind(null,t.syncEngine),n}function oW(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let oY=new Map;function oZ(e){if(Q.isDocumentKey(e))throw new N(S.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function oJ(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":x()}function oX(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=oJ(e);throw new N(S.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}let o0="firestore.googleapis.com";class o1{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new N(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=o0,this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new N(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new N(S.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oW(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class o2{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new o1({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new N(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new o1(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new k;switch(e.type){case"firstParty":return new M(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=oY.get(e);t&&(T("ComponentProvider","Removing Datastore"),oY.delete(e),t.terminate())}(this),Promise.resolve()}}class o5{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new o5(this.firestore,e,this._query)}}class o8{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new o4(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new o8(this.firestore,e,this._key)}}class o4 extends o5{constructor(e,t,n){super(e,t,nF(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new o8(this.firestore,null,new Q(e))}withConverter(e){return new o4(this.firestore,e,this._path)}}function o3(e,t,...n){if(e=(0,h.Ku)(e),function(e,t,n){if(!n)throw new N(S.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}("collection","path",t),e instanceof o2){let r=$.fromString(t,...n);return oZ(r),new o4(e,null,r)}{if(!(e instanceof o8||e instanceof o4))throw new N(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child($.fromString(t,...n));return oZ(r),new o4(e.firestore,null,r)}}let o6="AsyncQueue";class o9{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new al(this,"async_queue_retry"),this.bu=()=>{let e=aa();e&&T(o6,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.Su=e;let t=aa();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.bu)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;let t=aa();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.bu)}}enqueue(e){if(this.Du(),this.mu)return new Promise(()=>{});let t=new D;return this.vu(()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Vu.push(e),this.Cu()))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!ef(e))throw e;T(o6,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo(()=>this.Cu())}}vu(e){let t=this.Su.then(()=>(this.pu=!0,e().catch(e=>{let t;throw this.gu=e,this.pu=!1,E("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.pu=!1,e))));return this.Su=t,t}enqueueAfterDelay(e,t,n){this.Du(),this.wu.indexOf(e)>-1&&(t=0);let r=a$.createAndSchedule(this,e,t,n,e=>this.Fu(e));return this.fu.push(r),r}Du(){this.gu&&x()}verifyOperationInProgress(){}async Mu(){let e;do e=this.Su,await e;while(e!==this.Su)}xu(e){for(let t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then(()=>{for(let t of(this.fu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.fu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()})}Nu(e){this.wu.push(e)}Fu(e){let t=this.fu.indexOf(e);this.fu.splice(t,1)}}class o7 extends o2{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new o9,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new o9(e),this._firestoreClient=void 0,await e}}}function le(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r=(0,o.j6)(n,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tz});if(!r._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,n,r={}){var i;let s=(e=oX(e,o2))._getSettings(),a=Object.assign(Object.assign({},s),{emulatorOptions:e._getEmulatorOptions()}),o=`${t}:${n}`;s.host!==o0&&s.host!==o&&_("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l=Object.assign(Object.assign({},s),{host:o,ssl:!1,emulatorOptions:r});if(!(0,h.bD)(l,a)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=(0,h.Fy)(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);let s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new N(S.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(s)}e._authCredentials=new A(new C(t,n))}}(r,...e)}return r}function lt(e){if(e._terminated)throw new N(S.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||ln(e),e._firestoreClient}function ln(e){var t,n,r,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",new tK(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,oW(a.experimentalLongPollingOptions),a.useFetchStreams));e._componentsProvider||(null===(n=a.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=a.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new oz(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}class lr{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lr(tk.fromBase64String(e))}catch(e){throw new N(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lr(tk.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class li{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new j(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ls{constructor(e){this._methodName=e}}class la{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return P(this._lat,e._lat)||P(this._long,e._long)}}class lo{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let ll=/^__.*__$/;class lu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rv(e,this.data,this.fieldMask,t,this.fieldTransforms):new rw(e,this.data,t,this.fieldTransforms)}}class lh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rv(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x()}}class ld{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Bu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new ld(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;let n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.$u(e),r}Ku(e){var t;let n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.Bu(),r}Uu(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return lV(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(lc(this.Lu)&&ll.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class lf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ao(e)}ju(e,t,n,r=!1){return new ld({Lu:e,methodName:t,zu:n,path:j.emptyPath(),Qu:!1,Gu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lm(e){let t=e._freezeSettings(),n=ao(e._databaseId);return new lf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function lg(e,t,n,r,i,s={}){let a,o;let l=e.ju(s.merge||s.mergeFields?2:0,t,n,i);lD("Data must be an object, but it was:",l,r);let u=lS(r,l);if(s.merge)a=new tD(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=lC(t,r,n);if(!l.contains(i))throw new N(S.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lR(e,i)||e.push(i)}a=new tD(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lu(new na(u),a,o)}class lp extends ls{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof lp}}function ly(e,t,n){return new ld({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lw extends null{_toFieldTransform(e){return new rh(e.path,new rn)}isEqual(e){return e instanceof lw}}class lv extends ls{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ly(this,e,!0),n=new rr(this.Hu.map(e=>lx(e,t)));return new rh(e.path,n)}isEqual(e){return e instanceof lv&&(0,h.bD)(this.Hu,e.Hu)}}class lI extends ls{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ly(this,e,!0),n=new rs(this.Hu.map(e=>lx(e,t)));return new rh(e.path,n)}isEqual(e){return e instanceof lI&&(0,h.bD)(this.Hu,e.Hu)}}class lT extends ls{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){let t=new ro(e.serializer,n7(e.serializer,this.Ju));return new rh(e.path,t)}isEqual(e){return e instanceof lT&&this.Ju===e.Ju}}function lE(e,t,n,r){let i=e.ju(1,t,n);lD("Data must be an object, but it was:",i,r);let s=[],a=na.empty();return tI(r,(e,r)=>{let o=lA(t,e,n);r=(0,h.Ku)(r);let l=i.Ku(o);if(r instanceof lp)s.push(o);else{let e=lx(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new lh(a,new tD(s),i.fieldTransforms)}function l_(e,t,n,r,i,s){let a=e.ju(1,t,n),o=[lC(t,r,n)],l=[i];if(s.length%2!=0)throw new N(S.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(lC(t,s[e])),l.push(s[e+1]);let u=[],c=na.empty();for(let e=o.length-1;e>=0;--e)if(!lR(u,o[e])){let t=o[e],n=l[e];n=(0,h.Ku)(n);let r=a.Ku(t);if(n instanceof lp)u.push(t);else{let e=lx(n,r);null!=e&&(u.push(t),c.set(t,e))}}return new lh(c,new tD(u),a.fieldTransforms)}function lb(e,t,n,r=!1){return lx(n,e.ju(r?4:3,t))}function lx(e,t){if(lN(e=(0,h.Ku)(e)))return lD("Unsupported field value:",t,e),lS(e,t);if(e instanceof ls)return function(e,t){if(!lc(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");return function(e,t){let n=[],r=0;for(let i of e){let e=lx(i,t.Uu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return n7(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=q.fromDate(e);return{timestampValue:rY(t.serializer,n)}}if(e instanceof q){let n=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:rY(t.serializer,n)}}if(e instanceof la)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lr)return{bytesValue:rZ(t.serializer,e._byteString)};if(e instanceof o8){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Wu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:rX(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lo)return{mapValue:{fields:{[tG]:{stringValue:tH},[tW]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return n6(t.serializer,e)})}}}}};throw t.Wu(`Unsupported field value: ${oJ(e)}`)}(e,t)}function lS(e,t){let n={};return tT(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tI(e,(e,r)=>{let i=lx(r,t.qu(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function lN(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof la||e instanceof lr||e instanceof o8||e instanceof ls||e instanceof lo)}function lD(e,t,n){if(!lN(n)||"object"!=typeof n||null===n||Object.getPrototypeOf(n)!==Object.prototype&&null!==Object.getPrototypeOf(n)){let r=oJ(n);throw"an object"===r?t.Wu(e+" a custom object"):t.Wu(e+" "+r)}}function lC(e,t,n){if((t=(0,h.Ku)(t))instanceof li)return t._internalPath;if("string"==typeof t)return lA(e,t);throw lV("Field path arguments must be of type string or ",e,!1,void 0,n)}let lk=RegExp("[~\\*/\\[\\]]");function lA(e,t,n){if(t.search(lk)>=0)throw lV(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new li(...t.split("."))._internalPath}catch(r){throw lV(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function lV(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new N(S.INVALID_ARGUMENT,o+e+l)}function lR(e,t){return e.some(e=>e.isEqual(t))}class lM{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new o8(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lO(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lL("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lO extends lM{data(){return super.data()}}function lL(e,t){return"string"==typeof t?lA(e,t):t instanceof li?t._internalPath:t._delegate._internalPath}class lF{}class lP extends lF{}class lU extends lP{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new lU(e,t,n)}_apply(e){let t=this._parse(e);return lH(e._query,t),new o5(e.firestore,e.converter,nz(e._query,t))}_parse(e){let t=lm(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new N(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){lQ(a,s);let t=[];for(let n of a)t.push(lj(r,e,n));o={arrayValue:{values:t}}}else o=lj(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||lQ(a,s),o=lb(n,t,a,"in"===s||"not-in"===s);return nf.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lq extends lF{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lq(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nm.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())lH(n,e),n=nz(n,e)}(e._query,t),new o5(e.firestore,e.converter,nz(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lB extends lP{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lB(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nc(t,n)}(e._query,this._field,this._direction);return new o5(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new nL(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class lK extends lP{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new lK(e,t,n)}_apply(e){return new o5(e.firestore,e.converter,n$(e._query,this._limit,this._limitType))}}class lz extends lP{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lz(e,t,n)}_apply(e){var t;let n=lG(e,this.type,this._docOrFields,this._inclusive);return new o5(e.firestore,e.converter,new nL((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt))}}class l$ extends lP{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new l$(e,t,n)}_apply(e){var t;let n=lG(e,this.type,this._docOrFields,this._inclusive);return new o5(e.firestore,e.converter,new nL((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n))}}function lG(e,t,n,r){if(n[0]=(0,h.Ku)(n[0]),n[0]instanceof lM)return function(e,t,n,r,i){if(!r)throw new N(S.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of nq(e))if(n.field.isKeyField())s.push(t8(t,r.key));else{let e=r.data.field(n.field);if(tU(e))throw new N(S.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new N(S.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new nl(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=lm(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new N(S.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new N(S.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!nU(e)&&-1!==l.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child($.fromString(l));if(!Q.isDocumentKey(n))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new Q(n);o.push(t8(t,i))}else{let e=lb(n,r,l);o.push(e)}}return new nl(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function lj(e,t,n){if("string"==typeof(n=(0,h.Ku)(n))){if(""===n)throw new N(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!nU(t)&&-1!==n.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child($.fromString(n));if(!Q.isDocumentKey(r))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return t8(e,new Q(r))}if(n instanceof o8)return t8(e,n._key);throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${oJ(n)}.`)}function lQ(e,t){if(!Array.isArray(e)||0===e.length)throw new N(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function lH(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class lW{convertValue(e,t="none"){switch(tZ(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tR(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tM(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tI(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new lo(null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t[tW].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>tR(e.doubleValue)))}convertGeoPoint(e){return new la(tR(e.latitude),tR(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tq(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tB(e));default:return null}}convertTimestamp(e){let t=tV(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=$.fromString(e);il(n)||x();let r=new t$(n.get(1),n.get(3)),i=new Q(n.popFirst(5));return r.isEqual(t)||E(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function lY(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class lZ extends lW{constructor(e){super(),this.firestore=e}convertBytes(e){return new lr(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new o8(this.firestore,null,t)}}class lJ{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class lX extends lM{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new l0(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(lL("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class l0 extends lX{data(e={}){return super.data(e)}}class l1{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new lJ(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new l0(this._firestore,this._userDataWriter,n.key,n,new lJ(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new N(S.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new l0(e._firestore,e._userDataWriter,n.doc.key,n.doc,new lJ(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new l0(e._firestore,e._userDataWriter,t.doc.key,t.doc,new lJ(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return x()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}class l2 extends lW{constructor(e){super(),this.firestore=e}convertBytes(e){return new lr(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new o8(this.firestore,null,t)}}function l5(e){e=oX(e,o5);let t=oX(e.firestore,o7),n=lt(t),r=new l2(t);return function(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new N(S.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(e._query),(function(e,t,n={}){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oq({next:n=>{s.su(),t.enqueueAndForget(()=>aX(e,a)),n.fromCache&&"server"===r.source?i.reject(new N(S.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new a5(n,s,{includeMetadataChanges:!0,Ta:!0});return aJ(e,a)})(await oH(e),e.asyncQueue,t,n,r)),r.promise})(n,e._query).then(n=>new l1(t,r,e,n))}class l8{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=oU.provider,this._offlineComponentProvider={build:t=>new oF(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}function l4(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new N(S.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class l3{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=lm(e)}get(e){let t=l4(e,this._firestore),n=new lZ(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return x();let r=e[0];if(r.isFoundDocument())return new lM(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new lM(this._firestore,n,t._key,null,t.converter);throw x()})}set(e,t,n){let r=l4(e,this._firestore),i=lY(r.converter,t,n),s=lg(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i;let s=l4(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof li?l_(this._dataReader,"Transaction.update",s._key,t,n,r):lE(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=l4(e,this._firestore);return this._transaction.delete(t._key),this}}new WeakMap,!function(e,t=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:n,options:r})=>{let i=e.getProvider("app").getImmediate(),s=new o7(new V(e.getProvider("auth-internal")),new L(i,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new t$(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2017")}()}}]);